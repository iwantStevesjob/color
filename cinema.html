<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>P2P File Streamer (Final)</title>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; text-align: center; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: #111; padding: 20px; border-radius: 8px; border: 1px solid #333; }
        .hidden { display: none !important; }

        video { width: 100%; aspect-ratio: 16/9; background: #000; border: 1px solid #333; }

        /* Progress Bar */
        .track { width: 100%; height: 20px; background: #222; border-radius: 10px; margin: 15px 0; overflow: hidden; border: 1px solid #444; }
        .fill { height: 100%; background: #007bff; width: 0%; transition: width 0.2s; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; text-shadow: 0 1px 2px black; }
        .fill.done { background: #28a745; }

        button { padding: 12px 20px; border-radius: 6px; cursor: pointer; border: none; font-weight: bold; margin: 5px; background: #444; color: white; }
        button.primary { background: #007bff; }
        button:hover { filter: brightness(1.2); }
        input[type="text"] { padding: 10px; border-radius: 4px; border: none; text-align: center; }

        #logs { font-family: monospace; font-size: 11px; color: #666; text-align: left; height: 80px; overflow-y: auto; margin-top: 20px; border-top: 1px solid #222; }
    </style>
    <script type="module">
        import { joinRoom } from 'https://esm.run/trystero/torrent';
        window.joinRoom = joinRoom;
    </script>
</head>
<body>

<div class="container">
    <h2>P2P <span style="color:#007bff">File</span> Streamer</h2>

    <!-- SETUP -->
    <div id="setup">
        <input type="text" id="room" value="movie-night" placeholder="Room Name">
        <br><br>
        <div style="border:1px dashed #444; padding:20px; margin-bottom:20px;">
            <strong>HOST:</strong> <input type="file" id="file-in">
            <br><br>
            <button class="primary" onclick="startHost()">Send File</button>
        </div>
        <button onclick="startViewer()">Receive File</button>
    </div>

    <!-- PLAYER -->
    <div id="player" class="hidden">
        <video id="vid" controls playsinline></video>
        
        <div class="track">
            <div id="bar" class="fill">0%</div>
        </div>
        
        <div style="display:flex; justify-content:space-between; font-size:12px; color:#aaa;">
            <span id="status">Waiting for host...</span>
            <span id="details">0 / 0 MB</span>
        </div>

        <br>
        <button id="try-play-btn" onclick="buildAndPlay()" style="display:none; width:100%;">
            â–¶ Try Playing Now (Preview)
        </button>
    </div>

    <div id="logs"></div>
</div>

<script>
    const CHUNK_SIZE = 64 * 1024; // 64KB
    let room, sendBin, onBin;
    let file;
    let chunks = [];
    let receivedBytes = 0;
    let fileMeta = { size: 0, type: 'video/mp4', name: '' };
    let isHost = false;

    // --- HOST ---
    async function startHost() {
        const input = document.getElementById('file-in');
        if(!input.files.length) return alert("Select a file");
        file = input.files[0];
        isHost = true;
        
        showPlayer();
        log(`Host initialized. File: ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`);
        
        // Host plays local file immediately
        const vid = document.getElementById('vid');
        vid.src = URL.createObjectURL(file);
        document.getElementById('status').innerText = "Hosting... Waiting for peers.";
        document.getElementById('bar').style.width = "100%";
        document.getElementById('bar').classList.add('done');
        document.getElementById('bar').innerText = "HOSTING";

        initP2P();
    }

    // --- VIEWER ---
    function startViewer() {
        isHost = false;
        showPlayer();
        initP2P();
    }

    function showPlayer() {
        document.getElementById('setup').classList.add('hidden');
        document.getElementById('player').classList.remove('hidden');
    }

    // --- P2P LOGIC ---
    function initP2P() {
        if(!window.joinRoom) return alert("Library loading...");
        const roomName = document.getElementById('room').value;
        
        log(`Connecting to room: ${roomName}`);
        room = window.joinRoom({ appId: 'p2p-final-v4' }, roomName);
        
        const [send, getPid, onRecv] = room.makeAction('binary');
        sendBin = send;
        onBin = onRecv;

        room.onPeerJoin(peerId => {
            log(`Peer joined: ${peerId.substr(0,4)}`);
            if(isHost) {
                // 1. Send Metadata FIRST
                const meta = JSON.stringify({
                    type: 'META',
                    fileType: file.type || 'video/mp4',
                    size: file.size,
                    name: file.name
                });
                sendBin(new TextEncoder().encode(meta), peerId);

                // 2. Send File
                setTimeout(() => streamFile(peerId), 500);
            }
        });

        onBin((data, peerId) => {
            if(!isHost) handleData(data);
        });
    }

    // --- VIEWER DATA HANDLING ---
    function handleData(data) {
        // Check for Metadata (JSON)
        if(data.byteLength < 500) {
            try {
                const txt = new TextDecoder().decode(data);
                if(txt.includes('"type":"META"')) {
                    const meta = JSON.parse(txt);
                    fileMeta = meta;
                    log(`Metadata: ${meta.name} | ${meta.fileType} | ${(meta.size/1024/1024).toFixed(2)} MB`);
                    
                    // Reset
                    chunks = [];
                    receivedBytes = 0;
                    document.getElementById('status').innerText = "Receiving...";
                    
                    // Show "Try Play" button if file is large (allow user to attempt preview)
                    document.getElementById('try-play-btn').style.display = 'block';
                    return;
                }
            } catch(e) {}
        }

        // Binary Chunk
        chunks.push(data);
        receivedBytes += data.byteLength;

        // UI Updates
        const pct = (receivedBytes / fileMeta.size) * 100;
        document.getElementById('bar').style.width = pct + '%';
        document.getElementById('bar').innerText = Math.floor(pct) + '%';
        document.getElementById('details').innerText = `${(receivedBytes/1024/1024).toFixed(1)} / ${(fileMeta.size/1024/1024).toFixed(1)} MB`;

        // Completion Check
        if(receivedBytes >= fileMeta.size) {
            log("Download Complete!");
            document.getElementById('status').innerText = "Complete. Processing...";
            document.getElementById('bar').classList.add('done');
            document.getElementById('try-play-btn').style.display = 'none'; // Hide manual button
            
            buildAndPlay(true); // Auto-play
        }
    }

    // --- BUILD BLOB & PLAY ---
    function buildAndPlay(autoPlay = false) {
        if(chunks.length === 0) return;
        
        const vid = document.getElementById('vid');
        
        // Save timestamp if we are updating an existing stream
        const currentTime = vid.currentTime;
        const wasPlaying = !vid.paused;

        log(`Building video blob (${chunks.length} chunks)...`);
        
        // Create Blob with CORRECT MIME Type from Host
        const blob = new Blob(chunks, { type: fileMeta.fileType });
        const url = URL.createObjectURL(blob);
        
        vid.src = url;
        
        if(autoPlay) {
            // Force play on completion
            vid.muted = false; // Unmute
            vid.play().catch(e => {
                log("Auto-play blocked. Please click play on the video.");
                vid.muted = true; // Try muted
                vid.play();
            });
        } else {
            // Restore position if "Try Play" was clicked mid-stream
            vid.currentTime = currentTime;
            if(wasPlaying) vid.play();
        }
    }

    // --- HOST STREAMING ---
    function streamFile(targetId) {
        let offset = 0;
        const reader = new FileReader();

        reader.onload = e => {
            const chunk = e.target.result;
            sendBin(chunk, targetId);
            offset += CHUNK_SIZE;

            if(offset < file.size) {
                // 5ms delay to prevent buffer overflow
                setTimeout(readNext, 5); 
            } else {
                log("File sent successfully.");
            }
        };

        const readNext = () => {
            const slice = file.slice(offset, offset + CHUNK_SIZE);
            reader.readAsArrayBuffer(slice);
        };

        readNext();
    }

    function log(msg, type='') {
        const d = document.getElementById('logs');
        d.innerHTML = `<div style="${type==='ok'?'color:#28a745':''}">> ${msg}</div>` + d.innerHTML;
    }
</script>
</body>
</html>
