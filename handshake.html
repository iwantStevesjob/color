<!DOCTYPE html>
<html>
<head>
  <title>WebRTC Chat</title>
  <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
</head>
<body>
  v4:<br/>
  <button id="button" onclick="createOffer()">Create Offer</button><br>
  Offer SDP: <textarea id="offer" placeholder="Paste offer here"></textarea><br>
  
  Answer SDP: <textarea id="answer" placeholder="Paste answer here"></textarea><br>
  <div id="div"></div>
  
  Chat: <input id="chat" placeholder="Type your message here"></input><br>
  
  <script>
    var server = { urls: "stun:stun.l.google.com:19302" };
    var dc, pc = new RTCPeerConnection({ iceServers: [server] });

    pc.ondatachannel = e => dcInit(dc = e.channel);
    pc.oniceconnectionstatechange = e => log("ICE state: " + pc.iceConnectionState);

    // Handle ICE candidate gathering and signaling
    pc.onicecandidate = e => {
      if (e.candidate) {
        log("ICE candidate: " + JSON.stringify(e.candidate));
      } else {
        // All ICE candidates have been gathered, output SDP offer
        log("All ICE candidates gathered.");
        offer.value = pc.localDescription.sdp;
        offer.select();
        answer.placeholder = "Paste answer here";
      }
    };

    function dcInit() {
      dc.onopen = () => log("Chat is open!");
      dc.onmessage = e => log("Message received: " + e.data);
    }

    function createOffer() {
      button.disabled = true;
      dcInit(dc = pc.createDataChannel("chat"));
      pc.createOffer().then(d => pc.setLocalDescription(d)).catch(log);
    }

    // Handle offer SDP input from the other peer
    offer.oninput = e => {
      if (pc.signalingState != "stable") return;
      button.disabled = offer.disabled = true;
      
      var desc = new RTCSessionDescription({ type: "offer", sdp: offer.value });
      pc.setRemoteDescription(desc)
        .then(() => pc.createAnswer())
        .then(d => pc.setLocalDescription(d))
        .catch(log);
    };

    // Handle answer SDP input from the other peer
answer.oninput = e => {
  if (!enterPressed(e) || pc.signalingState != "have-local-offer") return;
  answer.disabled = true;

  var desc = new RTCSessionDescription({ type: "answer", sdp: answer.value });
  pc.setRemoteDescription(desc).then(() => log("Answer set successfully."))
    .catch(log);
};


    // Send chat messages over data channel
    chat.onkeypress = e => {
      if (e.keyCode != 13 || !dc) return;
      dc.send(chat.value);
      log("Sent: " + chat.value);
      chat.value = "";
    };

    var log = msg => div.innerHTML += "<p>" + msg + "</p>";
  </script>
</body>
</html>
