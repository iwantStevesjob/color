<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QR WebRTC Chat</title>
  
  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <style>
    :root { --bg: #121212; --surface: #1e1e1e; --primary: #bb86fc; --text: #e0e0e0; }
    body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
    .container { width: 100%; max-width: 600px; display: flex; flex-direction: column; gap: 20px; }
    .card { background: var(--surface); padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); text-align: center; }
    h1, h2 { color: var(--primary); margin-top: 0; }
    #qr-area { background: #fff; padding: 10px; display: inline-block; border-radius: 4px; margin: 10px 0; }
    #reader { width: 100%; border-radius: 8px; overflow: hidden; display: none; }
    .chat-box { height: 200px; overflow-y: auto; background: #000; padding: 10px; border: 1px solid #333; text-align: left; margin-bottom: 10px; }
    input { width: 70%; padding: 10px; border-radius: 4px; border: none; }
    button { padding: 10px 20px; background: var(--primary); border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }
    .hidden { display: none; }
    .step-instruction { font-size: 0.9rem; color: #aaa; margin-bottom: 10px; }
  </style>
</head>
<body>

<div class="container">
  
  <!-- Connection Panel -->
  <div id="setup-panel" class="card">
    <h1 id="status-title">Initializing...</h1>
    <p id="instruction" class="step-instruction">Please wait...</p>

    <!-- QR Display Area -->
    <div id="qr-container" class="hidden">
      <div id="qr-area"></div>
      <p style="color: #333; font-size: 0.8em;">Scan this with the other device</p>
    </div>

    <!-- Scanner Area -->
    <div id="scanner-container">
      <div id="reader"></div>
      <button id="btn-scan" class="hidden" onclick="startScanner()">Scan Partner's QR Code</button>
    </div>
  </div>

  <!-- Chat Panel (Hidden until connected) -->
  <div id="chat-panel" class="card hidden">
    <h2>Secure Chat</h2>
    <div id="chat-log" class="chat-box"></div>
    <div style="display: flex; gap: 10px;">
      <input type="text" id="chat-input" placeholder="Type message..." onkeypress="if(event.key==='Enter') sendMessage()">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

</div>

<script>
  // --- CONFIGURATION ---
  const pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
  let dataChannel;
  const loc = window.location;
  const baseUrl = loc.origin + loc.pathname;
  let isInitiator = false;
  let html5QrCode;

  // --- DOM ELEMENTS ---
  const statusTitle = document.getElementById('status-title');
  const instruction = document.getElementById('instruction');
  const qrContainer = document.getElementById('qr-container');
  const qrArea = document.getElementById('qr-area');
  const btnScan = document.getElementById('btn-scan');
  const chatPanel = document.getElementById('chat-panel');
  const setupPanel = document.getElementById('setup-panel');
  const chatLog = document.getElementById('chat-log');

  // --- 1. INITIALIZATION LOGIC ---
  window.onload = async () => {
    // Check if there is data in the URL Hash
    const hashData = loc.hash.substring(1); // Remove '#'

    if (hashData) {
      // CASE B: JOINER (Scanning the QR)
      isInitiator = false;
      statusTitle.innerText = "Joining Chat";
      instruction.innerText = "Processing connection data...";
      await handleJoiner(hashData);
    } else {
      // CASE A: INITIATOR (Opened page normally)
      isInitiator = true;
      statusTitle.innerText = "Start Chat";
      instruction.innerText = "Generating secure link...";
      createOffer();
    }
  };

  // --- 2. CORE WEBRTC FUNCTIONS ---

  // Setup Data Channel (Chat)
  pc.ondatachannel = e => setupChannel(e.channel);

  function setupChannel(dc) {
    dataChannel = dc;
    dc.onopen = () => {
      setupPanel.classList.add('hidden');
      chatPanel.classList.remove('hidden');
      log("Chat Connected!");
      if(html5QrCode) html5QrCode.stop(); // Stop camera if running
    };
    dc.onmessage = e => log("Peer: " + e.data);
  }

  // Create Offer (Host)
  async function createOffer() {
    const dc = pc.createDataChannel("chat");
    setupChannel(dc);
    
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    // Wait for ICE gathering to complete inside onicecandidate
  }

  // Handle Joiner Logic (Phone)
  async function handleJoiner(compressedSdp) {
    try {
      const sdpStr = LZString.decompressFromEncodedURIComponent(compressedSdp);
      const offer = JSON.parse(sdpStr);
      
      await pc.setRemoteDescription(offer);
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      // Wait for ICE gathering to complete
    } catch (e) {
      alert("Invalid QR Code or Link");
      console.error(e);
    }
  }

  // Handle ICE Candidates (Gathering network info)
  pc.onicecandidate = e => {
    if (e.candidate === null) {
      // Gathering complete. Now we generate the QR code.
      const data = JSON.stringify(pc.localDescription);
      const compressed = LZString.compressToEncodedURIComponent(data);
      
      if (isInitiator) {
        // Host: Show QR containing the URL + Hash
        const fullUrl = `${baseUrl}#${compressed}`;
        generateQR(fullUrl);
        instruction.innerText = "1. Scan this with your phone camera.";
        btnScan.classList.remove('hidden'); // Host needs to scan the answer later
      } else {
        // Joiner: Show QR containing just the Answer Data
        generateQR(compressed); // Just data, not URL, to keep it smaller
        instruction.innerText = "2. Show this QR code to the Host device.";
      }
    }
  };

  // --- 3. QR & SCANNER FUNCTIONS ---

  function generateQR(text) {
    qrArea.innerHTML = "";
    // Attempt to handle size limits. If URL is huge, QR might be dense.
    new QRCode(qrArea, {
      text: text,
      width: 256,
      height: 256,
      colorDark : "#000000",
      colorLight : "#ffffff",
      correctLevel : QRCode.CorrectLevel.L // Low error correction for less density
    });
    qrContainer.classList.remove('hidden');
  }

  function startScanner() {
    document.getElementById('reader').style.display = "block";
    btnScan.classList.add('hidden');
    qrContainer.classList.add('hidden'); // Hide own QR to clear screen space
    instruction.innerText = "Scan the QR code from the other device.";

    html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
      { facingMode: "environment" }, 
      { fps: 10, qrbox: 250 },
      (decodedText, decodedResult) => {
        // Success
        finishConnection(decodedText);
        html5QrCode.stop();
      },
      (errorMessage) => {
        // Parse error, ignore
      }
    ).catch(err => {
      alert("Camera permission failed.");
    });
  }

  async function finishConnection(compressedData) {
    try {
      // Host scans the Answer (raw compressed string, not URL)
      const sdpStr = LZString.decompressFromEncodedURIComponent(compressedData);
      const answer = JSON.parse(sdpStr);
      await pc.setRemoteDescription(answer);
      // Connection should open momentarily
      instruction.innerText = "Connecting...";
    } catch (e) {
      console.error(e);
      alert("Failed to read connection data.");
    }
  }

  // --- 4. CHAT UI ---
  function sendMessage() {
    const input = document.getElementById('chat-input');
    if(dataChannel && dataChannel.readyState === 'open' && input.value) {
      dataChannel.send(input.value);
      log("You: " + input.value);
      input.value = "";
    }
  }
  
  function log(msg) {
    const div = document.createElement('div');
    div.textContent = msg;
    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

</script>
</body>
</html>
