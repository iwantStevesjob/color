<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Optimized QR Chat</title>
  
  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <style>
    :root { --bg: #121212; --surface: #1e1e1e; --primary: #bb86fc; --text: #e0e0e0; }
    body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
    .container { width: 100%; max-width: 600px; display: flex; flex-direction: column; gap: 20px; }
    .card { background: var(--surface); padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); text-align: center; }
    h1, h2 { color: var(--primary); margin-top: 0; }
    
    /* QR Area Styles */
    #qr-area { background: #fff; padding: 15px; display: inline-block; border-radius: 4px; margin: 10px 0; cursor: zoom-in; transition: transform 0.2s; }
    #qr-area:active { transform: scale(1.5); } /* Click and hold to zoom */
    
    #reader { width: 100%; border-radius: 8px; overflow: hidden; display: none; background: #000; }
    .chat-box { height: 200px; overflow-y: auto; background: #000; padding: 10px; border: 1px solid #333; text-align: left; margin-bottom: 10px; font-family: monospace; }
    input { width: 65%; padding: 10px; border-radius: 4px; border: none; }
    button { padding: 10px 20px; background: var(--primary); border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }
    .hidden { display: none; }
    .text-link { color: #bb86fc; text-decoration: underline; cursor: pointer; font-size: 0.8em; }
  </style>
</head>
<body>

<div class="container">
  
  <!-- Setup Panel -->
  <div id="setup-panel" class="card">
    <h1 id="status-title">Initializing...</h1>
    <p id="instruction" style="color:#aaa;">Please wait...</p>

    <!-- QR Display -->
    <div id="qr-container" class="hidden">
      <div id="qr-area" title="Click to Zoom"></div>
      <p style="font-size: 0.8em; margin-top:5px;">
        <span id="qr-helper-text">Scan with other device.</span><br>
        <span style="color: #ffb74d; font-size: 0.9em;">(Tap QR to Zoom if camera struggles)</span>
      </p>
      
      <!-- Fallback Copy Button -->
      <button onclick="copyToClipboard()" style="font-size: 0.7em; background: #333; color: #fff; margin-top: 10px;">
        Scan failed? Copy Text Code
      </button>
    </div>

    <!-- Scanner -->
    <div id="scanner-container">
      <div id="reader"></div>
      <button id="btn-scan" class="hidden" onclick="startScanner()">Scan Partner's QR Code</button>
    </div>
  </div>

  <!-- Chat Panel -->
  <div id="chat-panel" class="card hidden">
    <h2>Connected</h2>
    <div id="chat-log" class="chat-box"></div>
    <div style="display: flex; gap: 10px;">
      <input type="text" id="chat-input" placeholder="Type a message..." onkeypress="if(event.key==='Enter') sendMessage()">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

</div>

<script>
  // --- CONFIG ---
  const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
  const pc = new RTCPeerConnection(config);
  let dataChannel;
  const loc = window.location;
  const baseUrl = loc.origin + loc.pathname;
  let isInitiator = false;
  let html5QrCode;
  let rawCompressedData = ""; // For clipboard fallback

  // --- UI HELPERS ---
  const statusTitle = document.getElementById('status-title');
  const instruction = document.getElementById('instruction');
  const qrContainer = document.getElementById('qr-container');
  const qrArea = document.getElementById('qr-area');
  const btnScan = document.getElementById('btn-scan');
  const chatPanel = document.getElementById('chat-panel');
  const setupPanel = document.getElementById('setup-panel');
  const chatLog = document.getElementById('chat-log');

  // --- 1. STARTUP ---
  window.onload = async () => {
    const hashData = loc.hash.substring(1);

    if (hashData) {
      // PHONE (Joiner)
      isInitiator = false;
      statusTitle.innerText = "Joining...";
      instruction.innerText = "Reading link data...";
      await handleJoiner(hashData);
    } else {
      // LAPTOP (Host)
      isInitiator = true;
      statusTitle.innerText = "Start Chat";
      instruction.innerText = "Generating Host QR...";
      createOffer();
    }
  };

  // --- 2. WEBRTC LOGIC ---
  pc.ondatachannel = e => setupChannel(e.channel);

  function setupChannel(dc) {
    dataChannel = dc;
    dc.onopen = () => {
      setupPanel.classList.add('hidden');
      chatPanel.classList.remove('hidden');
      if(html5QrCode) html5QrCode.stop(); 
    };
    dc.onmessage = e => log("Peer: " + e.data);
  }

  async function createOffer() {
    const dc = pc.createDataChannel("chat");
    setupChannel(dc);
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
  }

  async function handleJoiner(compressedSdp) {
    try {
      const sdpStr = LZString.decompressFromEncodedURIComponent(compressedSdp);
      const offer = JSON.parse(sdpStr);
      await pc.setRemoteDescription(offer);
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
    } catch (e) {
      alert("Link data corrupted. Try creating a new room.");
    }
  }

  // --- 3. SDP SLIMMING (The Magic Fix) ---
  // Removes TCP candidates and extra fluff to make QR code less dense
  function optimizeSDP(sdpObj) {
    let sdpLines = sdpObj.sdp.split('\r\n');
    
    // Filter out TCP candidates (usually bloated and hard to scan)
    // Filter out video/audio specific lines if present by default
    const filteredLines = sdpLines.filter(line => {
      if (line.includes("candidate") && line.includes(" tcp ")) return false; 
      return true;
    });

    return {
      type: sdpObj.type,
      sdp: filteredLines.join('\r\n')
    };
  }

  pc.onicecandidate = e => {
    if (e.candidate === null) {
      // ICE Gathering Complete.
      // 1. Get local description
      const originalSdp = pc.localDescription;
      
      // 2. STRIP unused data to make QR smaller
      const slimSdp = optimizeSDP(originalSdp);

      // 3. Compress
      const data = JSON.stringify(slimSdp);
      const compressed = LZString.compressToEncodedURIComponent(data);
      rawCompressedData = compressed; // Store for copy button

      if (isInitiator) {
        // Host: Needs to make a URL
        const fullUrl = `${baseUrl}#${compressed}`;
        generateQR(fullUrl);
        instruction.innerText = "1. Scan this with your Phone.";
        btnScan.classList.remove('hidden');
      } else {
        // Joiner: Just shows raw data
        generateQR(compressed);
        statusTitle.innerText = "Scan with Laptop";
        instruction.innerText = "2. Point laptop camera here.";
      }
    }
  };

  // --- 4. QR & SCANNER ---
  function generateQR(text) {
    qrArea.innerHTML = "";
    // Use lower error correction (L) because we want fewer dots
    new QRCode(qrArea, {
      text: text,
      width: 280,
      height: 280,
      colorDark : "#000000",
      colorLight : "#ffffff",
      correctLevel : QRCode.CorrectLevel.L 
    });
    qrContainer.classList.remove('hidden');
  }

  function startScanner() {
    document.getElementById('reader').style.display = "block";
    btnScan.classList.add('hidden');
    qrContainer.classList.add('hidden');
    instruction.innerText = "Hold phone steady in front of webcam.";

    html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
      { facingMode: "user" }, // "user" for webcam, "environment" for phone
      { fps: 10, qrbox: 250 },
      (decodedText) => {
        finishConnection(decodedText);
        html5QrCode.stop();
      },
      (errorMessage) => { /* scanning... */ }
    ).catch(err => {
      alert("Camera start failed. Ensure HTTPS is used.");
    });
  }

  async function finishConnection(compressedData) {
    try {
      const sdpStr = LZString.decompressFromEncodedURIComponent(compressedData);
      const answer = JSON.parse(sdpStr);
      await pc.setRemoteDescription(answer);
      instruction.innerText = "Connecting P2P...";
    } catch (e) {
      alert("Failed to read data. Try Copy/Paste fallback.");
    }
  }

  // --- 5. FALLBACKS ---
  function copyToClipboard() {
    if(!rawCompressedData) return;
    navigator.clipboard.writeText(rawCompressedData).then(() => {
      alert("Code copied! Email or text this code to your other device, then paste it manually.");
      // In a real app, we'd show a paste box, but for this simple file, 
      // we assume the QR fix will work. 
    });
  }

  function sendMessage() {
    const input = document.getElementById('chat-input');
    if(dataChannel && input.value) {
      dataChannel.send(input.value);
      log("You: " + input.value);
      input.value = "";
    }
  }
  
  function log(msg) {
    const div = document.createElement('div');
    div.textContent = msg;
    chatLog.appendChild(div);
  }
</script>
</body>
</html>
