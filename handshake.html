<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QR P2P Chat (Fixed)</title>
  
  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <style>
    :root { --bg: #121212; --surface: #1e1e1e; --primary: #bb86fc; --text: #e0e0e0; --accent: #03dac6; }
    body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
    .container { width: 100%; max-width: 600px; display: flex; flex-direction: column; gap: 15px; }
    .card { background: var(--surface); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.5); text-align: center; }
    h1, h2 { color: var(--primary); margin: 0 0 10px 0; font-size: 1.5rem; }
    
    /* QR & Video Area */
    #qr-area { background: #fff; padding: 15px; display: inline-block; border-radius: 8px; margin: 10px 0; }
    #reader { width: 100%; border-radius: 8px; overflow: hidden; display: none; background: #000; }
    
    /* Chat Box */
    .chat-box { height: 300px; overflow-y: auto; background: #000; padding: 15px; border: 1px solid #333; text-align: left; border-radius: 8px; display: flex; flex-direction: column; gap: 8px; }
    .msg { padding: 8px 12px; border-radius: 15px; max-width: 80%; word-wrap: break-word; }
    .msg.local { align-self: flex-end; background: var(--primary); color: #000; }
    .msg.remote { align-self: flex-start; background: #333; color: #fff; }
    .msg.sys { align-self: center; font-size: 0.8rem; color: #888; background: transparent; }

    /* Inputs */
    .input-group { display: flex; gap: 10px; margin-top: 10px; }
    input { flex-grow: 1; padding: 12px; border-radius: 6px; border: 1px solid #333; background: #2d2d2d; color: #fff; outline: none; }
    button { padding: 12px 24px; background: var(--primary); border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; }
    button:hover { filter: brightness(1.1); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }

    .hidden { display: none !important; }
    .status-indicator { font-size: 0.9rem; font-weight: bold; color: #aaa; margin-bottom: 15px; display: block;}
  </style>
</head>
<body>

<div class="container">
  
  <!-- CONNECTION PANEL -->
  <div id="setup-panel" class="card">
    <h1 id="page-title">Initiating...</h1>
    <span id="connection-state" class="status-indicator">State: New</span>
    <p id="instruction" style="color: #ccc;">Please wait...</p>

    <!-- QR Display -->
    <div id="qr-container" class="hidden">
      <div id="qr-area"></div>
    </div>

    <!-- Scanner -->
    <div id="scanner-container">
      <div id="reader"></div>
      <button id="btn-scan" class="hidden" onclick="startScanner()">Scan Partner's QR Code</button>
    </div>
  </div>

  <!-- CHAT PANEL -->
  <div id="chat-panel" class="card hidden">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h2>Secure Chat</h2>
      <button onclick="location.reload()" style="padding: 5px 10px; font-size: 0.8rem; background: #cf6679;">Disconnect</button>
    </div>
    <div id="chat-log" class="chat-box"></div>
    <div class="input-group">
      <input type="text" id="chat-input" placeholder="Type message..." autocomplete="off">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

</div>

<script>
  // --- CONFIGURATION ---
  const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
  const pc = new RTCPeerConnection(config);
  let dataChannel;
  let html5QrCode;
  let isInitiator = false;
  let isScanning = false;

  // --- DOM ELEMENTS ---
  const els = {
    setup: document.getElementById('setup-panel'),
    chat: document.getElementById('chat-panel'),
    title: document.getElementById('page-title'),
    instr: document.getElementById('instruction'),
    qrCont: document.getElementById('qr-container'),
    qrArea: document.getElementById('qr-area'),
    btnScan: document.getElementById('btn-scan'),
    state: document.getElementById('connection-state'),
    chatLog: document.getElementById('chat-log'),
    input: document.getElementById('chat-input'),
    reader: document.getElementById('reader')
  };

  // --- 1. STARTUP LOGIC ---
  window.onload = async () => {
    const hash = window.location.hash.substring(1);
    
    // MONITOR CONNECTION STATE (Fix for "Stuck" issue)
    pc.onconnectionstatechange = () => {
      els.state.innerText = `State: ${pc.connectionState}`;
      if(pc.connectionState === 'connected') {
        console.log("P2P Connected");
      } else if (pc.connectionState === 'failed') {
        alert("Connection Failed. Please refresh and try again.");
      }
    };

    if (hash) {
      // --- JOINER ---
      isInitiator = false;
      els.title.innerText = "Joining Chat";
      els.instr.innerText = "Reading connection data...";
      await handleJoiner(hash);
    } else {
      // --- INITIATOR ---
      isInitiator = true;
      els.title.innerText = "Start Chat";
      els.instr.innerText = "Generating offer...";
      await createOffer();
    }
  };

  // --- 2. WEBRTC LOGIC ---

  // Setup Data Channel (Event Listener)
  function setupChannel(dc) {
    dataChannel = dc;
    dc.onopen = () => {
      els.setup.classList.add('hidden');
      els.chat.classList.remove('hidden');
      log("Chat Connected!", "sys");
      els.input.focus();
      if(html5QrCode) html5QrCode.stop().catch(e=>{}); 
    };
    dc.onmessage = e => log(e.data, "remote");
  }

  // INITIATOR: Create Offer
  async function createOffer() {
    // Host creates the channel
    const dc = pc.createDataChannel("chat");
    setupChannel(dc);
    
    pc.onicecandidate = e => {
      if (!e.candidate) {
        // Gathering done -> Generate QR
        const data = JSON.stringify(pc.localDescription);
        const compressed = LZString.compressToEncodedURIComponent(data);
        const link = `${window.location.origin}${window.location.pathname}#${compressed}`;
        
        showQR(link);
        els.instr.innerHTML = "1. Scan this with the other device.<br>2. Then click 'Scan Partner' below.";
        els.btnScan.classList.remove('hidden');
      }
    };

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
  }

  // JOINER: Handle Link
  async function handleJoiner(hash) {
    // Joiner waits for channel from Host
    pc.ondatachannel = e => setupChannel(e.channel);

    pc.onicecandidate = e => {
      if (!e.candidate) {
        // Gathering done -> Generate QR (Raw Data, not Link)
        const data = JSON.stringify(pc.localDescription);
        const compressed = LZString.compressToEncodedURIComponent(data);
        
        showQR(compressed);
        els.instr.innerHTML = "Show this QR code to the Host device.";
      }
    };

    try {
      const offerStr = LZString.decompressFromEncodedURIComponent(hash);
      if(!offerStr) throw new Error("Invalid Link Data");
      
      const offer = JSON.parse(offerStr);
      await pc.setRemoteDescription(offer);
      
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
    } catch (e) {
      alert("Error parsing link: " + e.message);
    }
  }

  // HOST: Finish Connection (Scan Answer)
  async function finishConnection(compressedData) {
    try {
      els.instr.innerText = "Verifying handshake...";
      const answerStr = LZString.decompressFromEncodedURIComponent(compressedData);
      
      if (!answerStr) {
        throw new Error("Decompression failed. Try scanning again.");
      }

      const answer = JSON.parse(answerStr);
      await pc.setRemoteDescription(answer);
      els.instr.innerText = "Handshake Accepted. Connecting...";
    } catch (e) {
      console.error(e);
      alert(e.message);
      // If failed, allow scanning again
      els.btnScan.classList.remove('hidden');
    }
  }

  // --- 3. QR & SCANNER ---

  function showQR(text) {
    els.qrArea.innerHTML = "";
    els.qrCont.classList.remove('hidden');
    new QRCode(els.qrArea, {
      text: text,
      width: 256,
      height: 256,
      correctLevel : QRCode.CorrectLevel.L // Low error correction = less dense QR
    });
  }

  function startScanner() {
    if (isScanning) return;
    isScanning = true;

    els.qrCont.classList.add('hidden'); // Hide own QR
    els.btnScan.classList.add('hidden');
    els.reader.style.display = "block";
    els.instr.innerText = "Scan the QR code on the other device.";

    html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
      { facingMode: "environment" }, 
      { fps: 10, qrbox: 250 },
      (decodedText) => {
        // SUCCESS: Stop scanning immediately
        html5QrCode.stop().then(() => {
          els.reader.style.display = "none";
          isScanning = false;
          finishConnection(decodedText);
        });
      },
      (errorMessage) => { /* ignore parse errors */ }
    ).catch(err => {
      alert("Camera Error: " + err);
      isScanning = false;
      els.btnScan.classList.remove('hidden');
    });
  }

  // --- 4. CHAT UI ---

  els.input.addEventListener('keypress', (e) => {
    if(e.key === 'Enter') sendMessage();
  });

  function sendMessage() {
    const txt = els.input.value.trim();
    if (!txt || !dataChannel || dataChannel.readyState !== 'open') return;
    
    dataChannel.send(txt);
    log(txt, "local");
    els.input.value = "";
  }

  function log(msg, type) {
    const div = document.createElement('div');
    div.className = `msg ${type}`;
    div.innerText = msg;
    els.chatLog.appendChild(div);
    els.chatLog.scrollTop = els.chatLog.scrollHeight;
  }

</script>
</body>
</html>
