<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Native Share Chat</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
  
  <style>
    :root { --bg: #0d1117; --surface: #161b22; --border: #30363d; --primary: #2f81f7; --text: #c9d1d9; --btn-text: #ffffff; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
    .container { width: 100%; max-width: 600px; display: flex; flex-direction: column; gap: 20px; }
    
    /* Cards */
    .card { background: var(--surface); border: 1px solid var(--border); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    h2 { color: var(--primary); margin: 0 0 10px 0; font-size: 1.2rem; }
    p { color: #8b949e; font-size: 0.9rem; line-height: 1.5; margin-bottom: 15px; }
    
    /* Inputs */
    textarea { width: 100%; height: 80px; background: #000; color: #fff; border: 1px solid var(--border); border-radius: 6px; padding: 10px; font-family: monospace; font-size: 0.8rem; resize: none; box-sizing: border-box; }
    textarea:focus { outline: 2px solid var(--primary); border-color: transparent; }

    /* Buttons */
    .btn-group { display: flex; gap: 10px; margin-top: 10px; }
    button { flex: 1; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 0.9rem; }
    
    .btn-primary { background: var(--primary); color: var(--btn-text); }
    .btn-primary:hover { opacity: 0.9; }
    
    .btn-secondary { background: var(--border); color: var(--text); }
    .btn-secondary:hover { background: #444; }

    /* Chat */
    .hidden { display: none !important; }
    #chat-log { height: 300px; overflow-y: auto; background: #000; border: 1px solid var(--border); border-radius: 6px; padding: 10px; margin-bottom: 10px; }
    .msg { padding: 8px 12px; border-radius: 18px; margin-bottom: 8px; max-width: 80%; word-wrap: break-word; font-size: 0.95rem; }
    .msg.me { background: #1f6feb; color: white; align-self: flex-end; margin-left: auto; }
    .msg.peer { background: #21262d; color: #c9d1d9; align-self: flex-start; }
    
    .status-dot { display: inline-block; width: 8px; height: 8px; background: #ff7b72; border-radius: 50%; margin-right: 5px; }
    .status-dot.connected { background: #3fb950; box-shadow: 0 0 8px #3fb950; }
  </style>
</head>
<body>

<div class="container">

  <!-- HEADER -->
  <div style="display:flex; align-items:center; justify-content:space-between;">
    <h2 style="margin:0; color:#fff;">P2P Handshake</h2>
    <div style="font-size:0.8rem; color:#8b949e;">
      <span id="status-dot" class="status-dot"></span> <span id="status-text">Disconnected</span>
    </div>
  </div>

  <!-- STEP 1: OFFER -->
  <div id="step-1" class="card">
    <h2>1. The Host (Laptop)</h2>
    <p>Click Create Offer. Then use "Share" to send the text to your Phone (via Email, Telegram, or Notes).</p>
    <div class="btn-group">
      <button class="btn-primary" onclick="createOffer()">Create Offer</button>
      <button class="btn-secondary" id="btn-share-offer" onclick="shareData('local-sdp')" disabled>Share Offer ðŸ“¤</button>
      <button class="btn-secondary" onclick="copyData('local-sdp')">Copy ðŸ“‹</button>
    </div>
    <textarea id="local-sdp" readonly placeholder="Offer will appear here..." style="margin-top:10px;"></textarea>
  </div>

  <!-- STEP 2: ANSWER -->
  <div id="step-2" class="card">
    <h2>2. The Guest (Phone)</h2>
    <p>Paste the Offer above. Then click "Create Answer". Use <b>Nearby Share / AirDrop</b> to send the result back to the laptop.</p>
    <textarea id="remote-sdp" placeholder="Paste Remote SDP here..."></textarea>
    <div class="btn-group">
      <button class="btn-primary" onclick="acceptOffer()">Create Answer</button>
      <button class="btn-secondary" id="btn-share-answer" onclick="shareData('local-sdp')" disabled>Share Answer ðŸ“¤</button>
      <button class="btn-secondary" onclick="copyData('local-sdp')">Copy ðŸ“‹</button>
    </div>
  </div>

  <!-- STEP 3: FINALIZE -->
  <div id="step-3" class="card">
    <h2>3. Finalize</h2>
    <p>Paste the Answer received from the Phone here to start the chat.</p>
    <textarea id="final-sdp" placeholder="Paste Answer here..."></textarea>
    <div class="btn-group">
      <button class="btn-primary" onclick="finalize()">Connect ðŸš€</button>
    </div>
  </div>

  <!-- CHAT INTERFACE -->
  <div id="chat-interface" class="card hidden">
    <h2>Secure Chat</h2>
    <div id="chat-log"></div>
    <div style="display: flex; gap: 10px;">
      <input type="text" id="chat-msg" placeholder="Type a message..." style="flex:1; border-radius:6px; border:none; padding:12px;" onkeypress="handleKey(event)">
      <button class="btn-primary" style="flex:0 0 80px;" onclick="sendMsg()">Send</button>
    </div>
  </div>

</div>

<script>
  // --- CONFIG ---
  const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
  const pc = new RTCPeerConnection(config);
  let dataChannel;

  // --- UI REFS ---
  const els = {
    local: document.getElementById('local-sdp'),
    remote: document.getElementById('remote-sdp'),
    final: document.getElementById('final-sdp'),
    btnShareOffer: document.getElementById('btn-share-offer'),
    btnShareAnswer: document.getElementById('btn-share-answer'),
    statusDot: document.getElementById('status-dot'),
    statusText: document.getElementById('status-text'),
    chat: document.getElementById('chat-interface'),
    steps: [document.getElementById('step-1'), document.getElementById('step-2'), document.getElementById('step-3')]
  };

  // --- WEBRTC LOGIC ---

  // 1. HOST: Create Offer
  async function createOffer() {
    dataChannel = pc.createDataChannel("chat");
    setupChannel(dataChannel);
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    // Wait for ICE...
  }

  // 2. GUEST: Accept Offer, Create Answer
  async function acceptOffer() {
    const offerStr = els.remote.value.trim();
    if (!offerStr) return alert("Paste the Offer first!");
    
    try {
      const offer = JSON.parse(decompress(offerStr));
      await pc.setRemoteDescription(offer);
      
      pc.ondatachannel = e => setupChannel(e.channel); // Guest listens for channel
      
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      // Wait for ICE...
    } catch (e) {
      alert("Invalid Code. Make sure you copied the whole string.");
      console.error(e);
    }
  }

  // 3. HOST: Finalize Connection
  async function finalize() {
    const answerStr = els.final.value.trim();
    if (!answerStr) return alert("Paste the Answer first!");

    try {
      const answer = JSON.parse(decompress(answerStr));
      await pc.setRemoteDescription(answer);
    } catch (e) {
      alert("Connection failed. Check console.");
    }
  }

  // ICE Candidates -> Update Text Box
  pc.onicecandidate = e => {
    if (e.candidate === null) {
      // Finished gathering.
      const raw = JSON.stringify(pc.localDescription);
      const compressed = compress(raw);
      
      els.local.value = compressed;
      
      // Enable Share Buttons based on role
      if (pc.localDescription.type === 'offer') {
        els.btnShareOffer.disabled = false;
        els.btnShareOffer.innerText = "Share Offer (Ready)";
      } else {
        els.btnShareAnswer.disabled = false;
        els.btnShareAnswer.innerText = "Share Answer (Ready)";
      }
    }
  };

  function setupChannel(dc) {
    dataChannel = dc;
    dc.onopen = () => {
      els.statusDot.classList.add('connected');
      els.statusText.innerText = "Connected";
      els.statusText.style.color = "#3fb950";
      
      // Hide setup, show chat
      els.steps.forEach(s => s.classList.add('hidden'));
      els.chat.classList.remove('hidden');
    };
    dc.onmessage = e => addMsg(e.data, 'peer');
  }

  // --- SHARING TOOLS ---

  async function shareData(elementId) {
    const text = document.getElementById(elementId).value;
    if (!navigator.share) {
      alert("Your browser doesn't support Native Sharing. Please use the Copy button.");
      return;
    }
    try {
      await navigator.share({
        title: 'WebRTC Code',
        text: text
      });
    } catch (err) {
      console.log('Share canceled or failed', err);
    }
  }

  function copyData(elementId) {
    const text = document.getElementById(elementId).value;
    navigator.clipboard.writeText(text);
    alert("Copied to clipboard!");
  }

  // --- COMPRESSION (Safe for URL/Text) ---
  function compress(str) {
    // We remove TCP candidates to save space before compressing
    return LZString.compressToEncodedURIComponent(str);
  }
  
  function decompress(str) {
    return LZString.decompressFromEncodedURIComponent(str);
  }

  // --- CHAT UI ---
  function sendMsg() {
    const input = document.getElementById('chat-msg');
    const txt = input.value.trim();
    if (dataChannel && txt) {
      dataChannel.send(txt);
      addMsg(txt, 'me');
      input.value = "";
    }
  }

  function addMsg(txt, who) {
    const div = document.createElement('div');
    div.className = `msg ${who}`;
    div.innerText = txt;
    document.getElementById('chat-log').appendChild(div);
    document.getElementById('chat-log').scrollTop = 9999;
  }

  function handleKey(e) { if(e.key==='Enter') sendMsg(); }

</script>
</body>
</html>
