<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ultra-Minified Chat</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <style>
    :root { --bg: #000; --green: #0f0; --text: #eee; }
    body { font-family: monospace; background: var(--bg); color: var(--text); padding: 10px; display:flex; flex-direction:column; align-items:center; }
    
    .card { border: 1px solid #333; padding: 10px; margin-bottom: 10px; width: 100%; max-width: 600px; box-sizing: border-box; }
    textarea { width: 100%; height: 60px; background: #111; color: var(--green); border: none; font-size: 10px; resize: vertical; }
    
    .stat { font-size: 12px; margin-bottom: 5px; color: #aaa; }
    .diff { color: #fff; font-weight: bold; }

    #qr-area { background: #fff; padding: 10px; display: inline-block; margin: 10px 0; }
    #reader { width: 100%; max-width: 300px; border: 2px solid var(--green); display:none; }
    
    button { background: var(--green); border: none; padding: 10px; font-weight: bold; cursor: pointer; width: 100%; margin-top:5px; }
  </style>
</head>
<body>

  <div class="card">
    <div class="stat">RAW (Original)</div>
    <textarea id="box-raw" readonly></textarea>
  </div>

  <div class="card">
    <div id="stat-final" class="stat">ULTRA MINIFIED</div>
    <textarea id="box-final" readonly></textarea>
  </div>

  <div id="qr-area"></div>
  
  <div class="card">
    <button onclick="startScanner()">SCAN PARTNER</button>
    <div id="reader"></div>
  </div>

<script>
  const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
  const pc = new RTCPeerConnection(config);
  let isInitiator = true;

  // 1. REPLACEMENTS (Safe ASCII)
  const DICTIONARY = [
    { k: 'a=candidate:', v: '_' },
    { k: 'a=fingerprint:sha-256 ', v: '$' },
    { k: 'a=ice-ufrag:', v: '!' },
    { k: 'a=ice-pwd:', v: '@' },
    { k: 'a=group:BUNDLE 0', v: '*' },
    { k: 'a=msid-semantic: WMS', v: '^' },
    { k: 'm=application ', v: '|' },
    { k: 'UDP/DTLS/SCTP webrtc-datachannel', v: '%' },
    { k: ' generation 0', v: '' }, 
    { k: ' network-cost 999', v: '' }, 
    { k: ' typ host', v: 'H' },
    { k: ' typ srflx', v: 'S' },
    { k: 'tcptype', v: 'T' },
    { k: 'udp', v: 'U' },
    { k: '192.168.', v: 'L' },
    { k: ' raddr 0.0.0.0 rport 0', v: '' }, // Useless boilerplate
    { k: '\r\n', v: '~' },
    // BOILERPLATE MAPS (The new reductions)
    { k: 'a=setup:actpass', v: '1' },
    { k: 'a=setup:active', v: '2' },
    { k: 'a=mid:0', v: '3' },
    { k: 'a=sctp-port:5000', v: '4' },
    { k: 'a=max-message-size:262144', v: '5' }
  ];

  // --- START ---
  if(window.location.hash.length > 1) {
    isInitiator = false;
    handleJoin();
  } else {
    initHost();
  }

  async function initHost() {
    const dc = pc.createDataChannel("chat");
    setupChannel(dc);
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
  }

  pc.onicecandidate = e => {
    if (e.candidate === null) {
      const raw = pc.localDescription.sdp;
      document.getElementById('box-raw').value = raw;
      
      const minified = minify(raw);
      
      document.getElementById('box-final').value = minified;
      const red = Math.round((1 - (minified.length / raw.length)) * 100);
      document.getElementById('stat-final').innerHTML = `ULTRA MINIFIED (${minified.length} chars) <span class="diff">-${red}%</span>`;

      generateQR(minified);
    }
  };

  // --- THE ULTRA MINIFIER ---
  function minify(sdp) {
    let lines = sdp.split('\r\n');
    let keep = [];
    
    // 1. FILTER LINES
    lines.forEach(l => {
      // Remove standard headers (we reconstruct them)
      if(l.startsWith('v=') || l.startsWith('s=') || l.startsWith('t=')) return;
      
      // Remove Origin line (we reconstruct a fake one)
      if(l.startsWith('o=')) return;

      // Remove unwanted bloat
      if(l.includes(' tcp ') || l.includes('a=rtcp') || l.includes('IP6') || l.includes('extmap')) return;

      // Remove mDNS (.local) if we have other candidates. 
      // (UUIDs take up 40+ chars).
      if(l.includes('.local')) return; 

      keep.push(l);
    });

    let s = keep.join('\r\n');

    // 2. DICTIONARY SWAP
    DICTIONARY.forEach(p => { s = s.split(p.k).join(p.v); });

    // 3. HEX PACKING (Remove colons from Fingerprint)
    // Turns "$AA:BB:CC" into "$AABBCC"
    s = s.replace(/\$([0-9A-Fa-f:]+)/, (match, hex) => {
      return '$' + hex.replace(/:/g, '');
    });

    return s;
  }

  // --- THE RESTORER ---
  function unminify(str) {
    let s = str;

    // 1. UNPACK HEX (Add colons back to Fingerprint)
    // Matches the long hex string after '$'
    s = s.replace(/\$([0-9A-Fa-f]{60,})/, (match, hex) => {
      // Insert colon every 2 chars
      return '$' + hex.match(/.{1,2}/g).join(':');
    });

    // 2. DICTIONARY RESTORE
    for(let i = DICTIONARY.length - 1; i >= 0; i--) {
      if(DICTIONARY[i].v !== '') s = s.split(DICTIONARY[i].v).join(DICTIONARY[i].k);
    }

    // 3. RECONSTRUCT HEADERS
    // We add a fake Origin ID. Browsers accept this for new connections.
    const header = "v=0\r\no=- 123456 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n";
    return header + s;
  }

  function generateQR(data) {
    document.getElementById('qr-area').innerHTML = "";
    new QRCode(document.getElementById('qr-area'), {
      text: data, width: 250, height: 250,
      correctLevel: QRCode.CorrectLevel.L
    });
  }

  // --- LOGIC ---
  async function handleJoin() {
    const hash = window.location.hash.substring(1);
    const sdp = unminify(decodeURIComponent(hash));
    document.getElementById('box-raw').value = "Received URL Hash";
    document.getElementById('box-final').value = "Restored SDP:\n" + sdp;
    
    await pc.setRemoteDescription({ type: "offer", sdp });
    pc.ondatachannel = e => setupChannel(e.channel);
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
  }

  function startScanner() {
    document.getElementById('reader').style.display = 'block';
    const html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
      decoded => {
        html5QrCode.stop();
        let clean = decoded.includes('#') ? decoded.split('#')[1] : decoded;
        const sdp = unminify(clean);
        const type = isInitiator ? "answer" : "offer";
        pc.setRemoteDescription({ type, sdp }).then(() => alert("CONNECTED!"));
      }, err => {}
    );
  }

  function setupChannel(dc) {
    dc.onopen = () => { document.body.style.background = "#050"; alert("CHAT CONNECTED!"); };
    dc.onmessage = e => alert(e.data);
  }
</script>
</body>
</html>
