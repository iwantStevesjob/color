<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Deep Debug WebRTC</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <style>
    body { font-family: monospace; background: #000; color: #0f0; padding: 10px; display: flex; flex-direction: column; gap: 10px; }
    h2 { border-bottom: 1px solid #0f0; padding-bottom: 5px; margin: 0; }
    
    .box { border: 1px solid #333; padding: 10px; border-radius: 5px; background: #111; }
    
    /* The Debug Data Area */
    textarea { 
      width: 100%; height: 150px; 
      background: #220000; color: #ffcccc; 
      border: 1px solid #f00; font-size: 10px; 
      font-family: monospace;
      box-sizing: border-box;
    }
    
    label { color: #f00; font-weight: bold; display: block; margin-bottom: 5px; }

    button { 
      width: 100%; padding: 15px; 
      background: #004400; color: #fff; 
      border: 1px solid #0f0; font-weight: bold; 
      margin-top: 10px; cursor: pointer; font-size: 1.1rem;
    }
    button.scan { background: #000088; border-color: #55f; }

    #qr-area { background: #fff; padding: 10px; display: inline-block; margin: 10px auto; }
    #reader { width: 100%; display: none; border: 2px solid red; }
    .hidden { display: none !important; }
    
    #chat-ui { display: flex; gap: 5px; }
    input { flex: 1; padding: 10px; }
  </style>
</head>
<body>

  <!-- STEP 1: DEBUGGER UI -->
  <div id="debug-panel" class="box">
    <h2 id="step-title">Initializing...</h2>
    <p id="status">Waiting...</p>

    <!-- Raw Data Viewer -->
    <div id="data-viewer" class="hidden">
      <label>RAW DATA (Verify this matches peer!)</label>
      <textarea id="raw-output" readonly></textarea>
      <div id="data-info" style="font-size: 0.8rem; color: #aaa;"></div>
      <button id="btn-confirm" onclick="nextStep()">LOOKS GOOD, CONTINUE</button>
    </div>

    <!-- QR Zone -->
    <div id="qr-container" class="hidden" style="text-align: center;">
      <div id="qr-area"></div>
      <p>Scan this with other device</p>
    </div>

    <!-- Scanner Zone -->
    <div id="scanner-container" class="hidden">
      <div id="reader"></div>
      <button class="scan" onclick="openScanner()">OPEN SCANNER</button>
    </div>
  </div>

  <!-- STEP 2: CHAT UI -->
  <div id="chat-panel" class="box hidden">
    <h2>Connected</h2>
    <div id="chat-log" style="height: 200px; overflow-y: scroll; border: 1px solid #333; margin-bottom: 10px;"></div>
    <div id="chat-ui">
      <input type="text" id="msg-in" placeholder="Type...">
      <button onclick="send()" style="width: auto; margin: 0;">Send</button>
    </div>
  </div>

<script>
  // --- STATE MANAGEMENT ---
  const pc = new RTCPeerConnection({
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
  });
  let dc;
  let nextAction = null; // Stores the function to run after user confirms data
  let html5QrCode;

  // --- 1. BOOTSTRAP ---
  window.onload = async () => {
    const hash = window.location.hash.substring(1);
    
    // Log Connection State
    pc.onconnectionstatechange = () => {
      document.getElementById('status').innerText = "WebRTC State: " + pc.connectionState;
      if(pc.connectionState === 'connected') {
        document.getElementById('debug-panel').classList.add('hidden');
        document.getElementById('chat-panel').classList.remove('hidden');
      }
    };

    if(hash) {
      // JOINER FLOW
      document.getElementById('step-title').innerText = "STEP 1: Verify Host Data";
      document.getElementById('status').innerText = "Decoding URL hash...";
      
      // DECODE & SHOW RAW DATA
      try {
        const jsonStr = LZString.decompressFromEncodedURIComponent(hash);
        if(!jsonStr) throw new Error("Decompression failed");
        
        // Show data to user for verification
        showDebugData(jsonStr, async () => {
          // USER CONFIRMED: Set Remote Description
          document.getElementById('status').innerText = "Processing Offer...";
          await pc.setRemoteDescription(JSON.parse(jsonStr));
          prepareAnswer();
        });
      } catch(e) { alert(e.message); }

    } else {
      // HOST FLOW
      document.getElementById('step-title').innerText = "STEP 1: Create Offer";
      prepareOffer();
    }
  };

  // --- 2. HOST LOGIC ---
  async function prepareOffer() {
    dc = pc.createDataChannel("chat");
    setupDc(dc);
    
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    
    document.getElementById('status').innerText = "Gathering ICE (Network)...";
    
    // Wait for ICE gathering
    pc.onicecandidate = e => {
      if(!e.candidate) {
        // Gathering done. Show RAW JSON.
        const rawJson = JSON.stringify(pc.localDescription, null, 2);
        showDebugData(rawJson, () => {
          // USER CONFIRMED: Generate QR
          const compressed = LZString.compressToEncodedURIComponent(rawJson);
          const link = window.location.origin + window.location.pathname + "#" + compressed;
          generateQR(link);
          
          document.getElementById('step-title').innerText = "STEP 2: Wait for Answer";
          document.getElementById('scanner-container').classList.remove('hidden');
        });
      }
    };
  }

  // --- 3. JOINER LOGIC ---
  async function prepareAnswer() {
    pc.ondatachannel = e => setupDc(e.channel);
    
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);

    document.getElementById('status').innerText = "Gathering ICE...";
    
    pc.onicecandidate = e => {
      if(!e.candidate) {
        // Gathering done. Show RAW JSON.
        const rawJson = JSON.stringify(pc.localDescription, null, 2);
        document.getElementById('step-title').innerText = "STEP 2: Verify Answer Data";
        
        showDebugData(rawJson, () => {
          // USER CONFIRMED: Generate QR (Data only)
          const compressed = LZString.compressToEncodedURIComponent(rawJson);
          generateQR(compressed);
          document.getElementById('status').innerText = "Show this QR to Host";
        });
      }
    };
  }

  // --- 4. SCANNER & FINALIZATION ---
  async function handleScannedData(scannedText) {
    document.getElementById('status').innerText = "Decompressing...";
    try {
      // Try to decompress
      let rawJson = LZString.decompressFromEncodedURIComponent(scannedText);
      
      // Fallback: maybe it wasn't compressed? (Scanning errors)
      if(!rawJson && scannedText.startsWith('{')) rawJson = scannedText; 
      
      if(!rawJson) throw new Error("Could not decompress data");

      document.getElementById('step-title').innerText = "STEP 3: Verify Incoming Answer";
      
      // SHOW DATA BEFORE CONNECTING
      showDebugData(rawJson, async () => {
        document.getElementById('status').innerText = "Connecting...";
        await pc.setRemoteDescription(JSON.parse(rawJson));
      });

    } catch(e) {
      alert("Scan Error: " + e.message);
      document.getElementById('scanner-container').classList.remove('hidden');
    }
  }

  // --- HELPERS ---

  function showDebugData(data, onConfirmCallback) {
    // Hide everything else
    document.getElementById('qr-container').classList.add('hidden');
    document.getElementById('scanner-container').classList.add('hidden');
    
    // Show Data
    const ui = document.getElementById('data-viewer');
    const textarea = document.getElementById('raw-output');
    const info = document.getElementById('data-info');
    
    ui.classList.remove('hidden');
    textarea.value = data;
    info.innerText = `Length: ${data.length} chars | Type: ${JSON.parse(data).type}`;
    
    // Store the callback
    nextAction = onConfirmCallback;
  }

  function nextStep() {
    document.getElementById('data-viewer').classList.add('hidden');
    if(nextAction) nextAction();
  }

  function generateQR(text) {
    document.getElementById('qr-area').innerHTML = "";
    document.getElementById('qr-container').classList.remove('hidden');
    new QRCode(document.getElementById('qr-area'), {
      text: text, width: 250, height: 250, correctLevel: QRCode.CorrectLevel.L
    });
  }

  function openScanner() {
    document.getElementById('reader').style.display = "block";
    html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 },
      (decodedText) => {
        html5QrCode.stop();
        document.getElementById('reader').style.display = "none";
        handleScannedData(decodedText);
      },
      () => {}
    );
  }

  function setupDc(channel) {
    dc = channel;
    dc.onopen = () => console.log("CHANNEL OPEN");
    dc.onmessage = e => {
      const d = document.createElement('div');
      d.innerText = "Peer: " + e.data;
      document.getElementById('chat-log').appendChild(d);
    }
  }

  function send() {
    const el = document.getElementById('msg-in');
    if(dc) dc.send(el.value);
    const d = document.createElement('div');
    d.innerText = "Me: " + el.value;
    d.style.color = "#fff";
    document.getElementById('chat-log').appendChild(d);
    el.value = "";
  }

</script>
</body>
</html>
