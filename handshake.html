<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Legacy Compatible Chat</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <style>
    :root { --bg: #121212; --surface: #222; --primary: #7d4f9d; --text: #eee; --ok: #4caf50; --err: #f44336; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
    .container { width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 15px; }
    .card { background: var(--surface); padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); text-align: center; }
    h2 { color: #bb86fc; margin: 0 0 10px 0; font-size: 1.3rem; }
    p { color: #aaa; font-size: 0.9rem; margin-bottom: 15px; }
    
    #qr-area { background: #fff; padding: 10px; display: inline-block; border-radius: 8px; margin: 10px auto; }
    #reader { width: 100%; border-radius: 8px; overflow: hidden; display: none; background: #000; margin-bottom: 10px; }
    
    .chat-window { height: 300px; overflow-y: auto; background: #000; padding: 10px; border: 1px solid #333; border-radius: 8px; display: flex; flex-direction: column; gap: 8px; text-align: left; }
    .msg { padding: 8px 12px; border-radius: 15px; max-width: 85%; word-wrap: break-word; font-size: 0.95rem; }
    .msg.local { align-self: flex-end; background: #bb86fc; color: #000; }
    .msg.remote { align-self: flex-start; background: #333; color: #fff; }
    .msg.sys { align-self: center; font-size: 0.8rem; color: #666; background: transparent; }

    .controls { display: flex; gap: 10px; margin-top: 10px; }
    input { flex: 1; padding: 12px; border-radius: 6px; border: 1px solid #444; background: #333; color: #fff; font-size: 16px; }
    button { padding: 12px 20px; background: #bb86fc; border: none; border-radius: 6px; font-weight: bold; color: #000; font-size: 1rem; }
    button.red { background: var(--err); color: #fff; }
    
    .status-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; background: #333; color: #aaa; margin-bottom: 10px; }
    .status-badge.connected { background: var(--ok); color: #000; }
    .status-badge.failed { background: var(--err); color: #fff; }

    .hidden { display: none !important; }
  </style>
</head>
<body>

<div class="container">
  
  <!-- SETUP PANEL -->
  <div id="setup-panel" class="card">
    <h2 id="mode-title">Initializing...</h2>
    <div id="status-badge" class="status-badge">State: Ready</div>
    <p id="instruction">Please wait...</p>

    <!-- QR CODE -->
    <div id="qr-wrapper" class="hidden">
      <div id="qr-area"></div>
    </div>

    <!-- CAMERA -->
    <div id="reader"></div>

    <button id="btn-scan" class="hidden" onclick="startScanner()">Scan Partner's Code</button>
    
    <!-- Hard Reset for stuck devices -->
    <div style="margin-top: 20px;">
      <button class="red" onclick="window.location.href=window.location.pathname" style="font-size: 0.8rem; padding: 8px 15px;">Reset / Reload</button>
    </div>
  </div>

  <!-- CHAT PANEL -->
  <div id="chat-panel" class="card hidden">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
      <h2>Secure Chat</h2>
      <button class="red" onclick="location.reload()" style="padding:6px 12px; font-size:0.8rem;">Exit</button>
    </div>
    <div id="chat-log" class="chat-window"></div>
    <div class="controls">
      <input type="text" id="chat-input" placeholder="Message..." autocomplete="off">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

</div>

<script>
  // --- COMPATIBILITY CONFIGURATION ---
  const config = { 
    iceServers: [
      { urls: "stun:stun.l.google.com:19302" },
      { urls: "stun:stun1.l.google.com:19302" } // Backup STUN
    ],
    iceCandidatePoolSize: 10
  };

  // iOS Legacy DataChannel Config
  const dcConfig = { 
    ordered: false, // UDP-style (Better for older devices/bad networks)
    maxRetransmits: 0 
  };

  const pc = new RTCPeerConnection(config);
  let dataChannel;
  let html5QrCode;
  let isScanning = false;
  let iceGatheringTimeout;

  // DOM Elements
  const ui = {
    setup: document.getElementById('setup-panel'),
    chat: document.getElementById('chat-panel'),
    title: document.getElementById('mode-title'),
    instr: document.getElementById('instruction'),
    qrWrap: document.getElementById('qr-wrapper'),
    qrArea: document.getElementById('qr-area'),
    btnScan: document.getElementById('btn-scan'),
    status: document.getElementById('status-badge'),
    log: document.getElementById('chat-log'),
    input: document.getElementById('chat-input'),
    reader: document.getElementById('reader')
  };

  // --- 1. INITIALIZATION ---
  window.onload = async () => {
    // 1. Connection Monitoring
    pc.onconnectionstatechange = () => {
      const state = pc.connectionState;
      ui.status.innerText = `State: ${state.toUpperCase()}`;
      ui.status.className = 'status-badge ' + state;
      
      if (state === 'failed' || state === 'disconnected') {
        ui.instr.innerText = "Connection Failed. Try reloading both devices.";
        ui.instr.style.color = "#f44336";
      }
    };

    // 2. Determine Role
    const hash = window.location.hash.substring(1);
    if (hash) {
      // JOINER (iPhone usually)
      ui.title.innerText = "Joiner Mode";
      ui.instr.innerText = "Processing Host data...";
      await handleJoiner(hash);
    } else {
      // INITIATOR (Android usually)
      ui.title.innerText = "Host Mode";
      ui.instr.innerText = "Creating secure room...";
      await createOffer();
    }
  };

  // --- 2. WEBRTC CORE ---

  function onChannelOpen() {
    ui.setup.classList.add('hidden');
    ui.chat.classList.remove('hidden');
    log("System: Connected via WebRTC", "sys");
    if(html5QrCode) html5QrCode.stop().catch(e=>{});
  }

  // Set up ICE listener with TIMEOUT (Fix for stuck iPhones)
  function waitForIce(callback) {
    let finished = false;

    // Standard completion
    pc.onicecandidate = e => {
      if (!e.candidate && !finished) {
        finished = true;
        clearTimeout(iceGatheringTimeout);
        callback();
      }
    };

    // Fallback Timeout: If device takes > 2s to find IP, just go with what we have
    iceGatheringTimeout = setTimeout(() => {
      if (!finished) {
        console.warn("ICE gathering timed out, sending partial candidates.");
        finished = true;
        callback();
      }
    }, 2000); // 2 second max wait
  }

  async function createOffer() {
    // Host creates simplified channel
    const dc = pc.createDataChannel("chat", dcConfig);
    dc.onopen = onChannelOpen;
    dc.onmessage = e => log(e.data, "remote");
    dataChannel = dc;

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    waitForIce(() => {
      // Compress and Show QR
      const data = JSON.stringify(pc.localDescription);
      const compressed = LZString.compressToEncodedURIComponent(data);
      const url = `${window.location.origin}${window.location.pathname}#${compressed}`;
      
      showQR(url);
      ui.instr.innerHTML = "1. Scan this with the old iPhone.<br>2. When iPhone shows QR, click below.";
      ui.btnScan.classList.remove('hidden');
    });
  }

  async function handleJoiner(hash) {
    pc.ondatachannel = e => {
      dataChannel = e.channel;
      dataChannel.onopen = onChannelOpen;
      dataChannel.onmessage = ev => log(ev.data, "remote");
    };

    try {
      const offerStr = LZString.decompressFromEncodedURIComponent(hash);
      await pc.setRemoteDescription(JSON.parse(offerStr));

      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      waitForIce(() => {
        const data = JSON.stringify(pc.localDescription);
        const compressed = LZString.compressToEncodedURIComponent(data);
        
        // Show RAW DATA QR (Not URL)
        showQR(compressed);
        ui.instr.innerText = "Show this QR code to the Android Host.";
      });

    } catch (e) {
      alert("Link Invalid. Resetting...");
      window.location.hash = "";
      location.reload();
    }
  }

  async function finishHandshake(compressedString) {
    try {
      ui.instr.innerText = "Verifying answer...";
      const answerStr = LZString.decompressFromEncodedURIComponent(compressedString);
      if(!answerStr) throw new Error("Bad QR Scan");
      
      await pc.setRemoteDescription(JSON.parse(answerStr));
      ui.instr.innerText = "Connecting... (This may take 10s)";
    } catch (e) {
      alert("Scan Failed: " + e.message);
      ui.btnScan.classList.remove('hidden');
    }
  }

  // --- 3. QR TOOLS ---

  function showQR(text) {
    ui.qrWrap.classList.remove('hidden');
    ui.qrArea.innerHTML = "";
    new QRCode(ui.qrArea, {
      text: text,
      width: 250,
      height: 250,
      correctLevel: QRCode.CorrectLevel.L
    });
  }

  function startScanner() {
    if(isScanning) return;
    isScanning = true;
    
    ui.qrWrap.classList.add('hidden');
    ui.btnScan.classList.add('hidden');
    ui.reader.style.display = "block";
    ui.instr.innerText = "Point camera at the other device.";

    html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
      { facingMode: "environment" }, 
      { fps: 10, qrbox: 250 },
      (decodedText) => {
        html5QrCode.stop().then(() => {
          ui.reader.style.display = "none";
          isScanning = false;
          finishHandshake(decodedText);
        });
      },
      () => {}
    ).catch(e => {
      alert("Camera Error. Ensure HTTPS is used.");
      location.reload();
    });
  }

  // --- 4. CHAT LOGIC ---

  ui.input.addEventListener('keypress', e => {
    if(e.key === 'Enter') sendMessage();
  });

  function sendMessage() {
    const txt = ui.input.value.trim();
    if(!txt || !dataChannel || dataChannel.readyState !== 'open') return;
    
    dataChannel.send(txt);
    log(txt, "local");
    ui.input.value = "";
  }

  function log(msg, type) {
    const div = document.createElement('div');
    div.className = `msg ${type}`;
    div.textContent = msg;
    ui.log.appendChild(div);
    ui.log.scrollTop = ui.log.scrollHeight;
  }

</script>
</body>
</html>
