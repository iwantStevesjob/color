<!DOCTYPE html>
<html>
<head>
  <title>WebRTC Chat</title>
  <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
</head>
<body>
  V2 <BR/>
  <button id="button" onclick="createOffer()">Offer:</button>
  <textarea id="offer" placeholder="Paste offer here"></textarea><br>
  
  Answer: <textarea id="answer"></textarea><br>
  <div id="div"></div>
  
  Chat: <input id="chat"></input><br>
  
  <script>
    var server = { urls: "stun:stun.l.google.com:19302" };
    var dc, pc = new RTCPeerConnection({ iceServers: [server] });

    pc.ondatachannel = e => dcInit(dc = e.channel);
    pc.oniceconnectionstatechange = e => log("ICE state: " + pc.iceConnectionState);
    
    pc.onicecandidate = e => {
      if (e.candidate) {
        log("ICE candidate: " + JSON.stringify(e.candidate));
      } else {
        // No more candidates, means signaling is done
        offer.value = pc.localDescription.sdp;
        offer.select();
        answer.placeholder = "Paste answer here";
      }
    };

    function dcInit() {
      dc.onopen = () => log("Chat is open!");
      dc.onmessage = e => log("Message: " + e.data);
    }

    function createOffer() {
      button.disabled = true;
      dcInit(dc = pc.createDataChannel("chat"));
      
      pc.createOffer().then(d => pc.setLocalDescription(d)).catch(log);
    }

    offer.onkeypress = e => {
      if (!enterPressed(e) || pc.signalingState != "stable") return;
      button.disabled = offer.disabled = true;
      
      var desc = new RTCSessionDescription({ type: "offer", sdp: offer.value });
      pc.setRemoteDescription(desc)
        .then(() => pc.createAnswer())
        .then(d => pc.setLocalDescription(d))
        .catch(log);
    };

    answer.onkeypress = e => {
      if (!enterPressed(e) || pc.signalingState != "have-local-offer") return;
      answer.disabled = true;

      var desc = new RTCSessionDescription({ type: "answer", sdp: answer.value });
      pc.setRemoteDescription(desc).catch(log);
    };

    chat.onkeypress = e => {
      if (!enterPressed(e)) return;
      dc.send(chat.value);
      log("Sent: " + chat.value);
      chat.value = "";
    };

    var enterPressed = e => e.keyCode == 13;
    var log = msg => div.innerHTML += "<p>" + msg + "</p>";
  </script>
</body>
</html>
