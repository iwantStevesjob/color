<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bio-Attestation Lab</title>
    <style>
        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --accent: #38bdf8;
            --danger: #f43f5e;
            --success: #10b981;
            --text: #f1f5f9;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 400px;
            background: var(--card);
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }

        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { font-size: 1.2rem; margin: 0; color: var(--accent); }
        .header p { font-size: 0.8rem; color: #94a3b8; }

        .viz-container {
            background: #000;
            border-radius: 12px;
            margin-bottom: 12px;
            position: relative;
            height: 100px;
            border: 1px solid #334155;
            overflow: hidden;
        }

        canvas { width: 100%; height: 100%; display: block; }

        .label {
            position: absolute;
            top: 5px;
            left: 8px;
            font-size: 10px;
            color: #64748b;
            font-weight: bold;
            text-transform: uppercase;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-val { display: block; font-weight: bold; font-size: 1rem; }
        .stat-lbl { font-size: 0.6rem; color: #64748b; text-transform: uppercase; }

        .btn {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            border: none;
            background: var(--accent);
            color: #0f172a;
            font-weight: 800;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.1s;
            touch-action: manipulation;
        }

        .btn:active { transform: scale(0.98); }
        .btn:disabled { background: #475569; cursor: not-allowed; }

        #verdict-box {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Hardware Attestation</h1>
        <p>Analyzing microscopic clock jitter & recoil</p>
    </div>

    <div class="viz-container">
        <span class="label">Signal Entropy (Tremor)</span>
        <canvas id="tremorCanvas"></canvas>
    </div>

    <div class="viz-container">
        <span class="label">Heartbeat Magnifier (BCG)</span>
        <canvas id="heartCanvas"></canvas>
    </div>

    <div class="stats-grid">
        <div class="stat-item">
            <span id="stat-jitter" class="stat-val">--</span>
            <span class="stat-lbl">Clock Jitter</span>
        </div>
        <div class="stat-item">
            <span id="stat-bpm" class="stat-val">--</span>
            <span class="stat-lbl">Est. Heart Rate</span>
        </div>
    </div>

    <button id="mainBtn" class="btn" onclick="requestAccess()">START SCAN</button>

    <div id="verdict-box"></div>
</div>

<script>
    let isRecording = false;
    let events = [];
    let lastTime = 0;
    const duration = 6000;

    const tCanvas = document.getElementById('tremorCanvas');
    const hCanvas = document.getElementById('heartCanvas');
    const tCtx = tCanvas.getContext('2d');
    const hCtx = hCanvas.getContext('2d');

    // Handle high DPI displays
    function setupCanvas(canvas) {
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
    }

    setupCanvas(tCanvas);
    setupCanvas(hCanvas);

    async function requestAccess() {
        if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
            try {
                const permission = await DeviceMotionEvent.requestPermission();
                if (permission !== 'granted') {
                    alert('Sensor access denied.');
                    return;
                }
            } catch (e) {
                console.error(e);
            }
        }
        startApp();
    }

    function startApp() {
        isRecording = true;
        events = [];
        lastTime = performance.now();
        
        const btn = document.getElementById('mainBtn');
        btn.disabled = true;
        btn.innerText = "CAPTURING...";

        document.getElementById('verdict-box').style.display = 'none';

        window.addEventListener('devicemotion', handleMotion);
        
        requestAnimationFrame(renderLoop);
        setTimeout(finishScan, duration);
    }

    function handleMotion(e) {
        if (!isRecording) return;
        const now = performance.now();
        const dt = now - lastTime;
        lastTime = now;

        const acc = e.accelerationIncludingGravity || {x:0, y:0, z:0};
        events.push({
            t: now,
            dt: dt,
            x: acc.x || 0,
            y: acc.y || 0,
            z: acc.z || 0
        });
    }

    function renderLoop() {
        if (!isRecording) return;

        // Draw Tremor (High Pass)
        drawGraph(tCtx, tCanvas, events.slice(-100), (d) => d.x * 20, '#38bdf8');
        
        // Draw Heartbeat (Low Pass + Magnified)
        const heartData = events.slice(-100);
        const meanZ = heartData.reduce((a, b) => a + b.z, 0) / (heartData.length || 1);
        drawGraph(hCtx, hCanvas, heartData, (d) => (d.z - meanZ) * 400, '#f43f5e');

        requestAnimationFrame(renderLoop);
    }

    function drawGraph(ctx, canvas, data, mapFn, color) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (data.length < 2) return;

        ctx.strokeStyle = color;
        ctx.lineWidth = 3;
        ctx.lineJoin = 'round';
        ctx.beginPath();

        const spacing = canvas.width / (data.length - 1);
        data.forEach((d, i) => {
            const x = i * spacing;
            const y = (canvas.height / 2) - mapFn(d);
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        });
        ctx.stroke();
    }

    function finishScan() {
        isRecording = false;
        window.removeEventListener('devicemotion', handleMotion);
        
        const btn = document.getElementById('mainBtn');
        btn.disabled = false;
        btn.innerText = "RE-SCAN";

        processResults();
    }

    function processResults() {
        if (events.length < 50) {
            showVerdict("INSUFFICIENT DATA", "Please ensure you are on a mobile device.", "var(--danger)");
            return;
        }

        // 1. Clock Jitter Attestation
        const deltas = events.slice(10).map(e => e.dt);
        const avg = deltas.reduce((a,b) => a+b, 0) / deltas.length;
        const jitter = Math.sqrt(deltas.reduce((a,b) => a + Math.pow(b-avg, 2), 0) / deltas.length);
        
        document.getElementById('stat-jitter').innerText = jitter.toFixed(3) + "ms";

        // 2. Heart Rate Estimate (BPM)
        const zData = events.map(e => e.z);
        const meanZ = zData.reduce((a,b) => a+b)/zData.length;
        let peaks = 0;
        for(let i=2; i<zData.length-2; i++) {
            if (zData[i] > zData[i-1] && zData[i] > zData[i+1] && zData[i] > meanZ + 0.05) peaks++;
        }
        const bpm = Math.round((peaks / (duration/1000)) * 60 / 2);
        document.getElementById('stat-bpm').innerText = (bpm > 45 && bpm < 120) ? bpm : "--";

        // Logic check
        const verdictBox = document.getElementById('verdict-box');
        if (jitter < 0.05) {
            showVerdict("BOT DETECTED", "Signal timing is too perfect. Hardware clock variance missing.", "var(--danger)");
        } else if (jitter > 10) {
            showVerdict("STABILITY ERROR", "Environment too noisy or browser throttling detected.", "orange");
        } else {
            showVerdict("HUMAN VERIFIED", "Unique hardware clock jitter and micro-tremors detected.", "var(--success)");
        }
    }

    function showVerdict(title, desc, color) {
        const box = document.getElementById('verdict-box');
        box.style.display = 'block';
        box.style.background = color + "22";
        box.style.border = "1px solid " + color;
        box.innerHTML = `<strong style="color:${color}">${title}</strong><br><span style="color:#94a3b8; font-size:0.75rem">${desc}</span>`;
    }
</script>

</body>
</html>

