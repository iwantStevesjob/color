<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bio-Telemetry: Heartbeat & Tremor</title>
    <style>
        :root {
            --bg: #0a0a12;
            --card: #16213e;
            --primary: #0f3460;
            --accent: #e94560;
            --text: #e0e0e0;
            --success: #4cc9f0;
            --heart: #ff4d4d;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .container {
            background-color: var(--card);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
            max-width: 450px;
            width: 100%;
        }

        h1 { margin: 0 0 10px 0; font-size: 1.4rem; color: var(--success); }
        .subtitle { color: #8a8a8a; font-size: 0.85rem; margin-bottom: 20px; line-height: 1.4; }

        .graph-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
            margin-bottom: 5px;
            text-align: left;
            display: flex;
            justify-content: space-between;
        }

        .meter-container {
            width: 100%;
            height: 120px;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            margin-bottom: 15px;
            border: 1px solid #222;
        }

        #heart-line {
            stroke: var(--heart);
            stroke-width: 2.5;
            fill: none;
            filter: drop-shadow(0 0 5px rgba(255, 77, 77, 0.4));
        }

        #tremor-line {
            stroke: var(--success);
            stroke-width: 1.5;
            fill: none;
        }

        .btn {
            background: linear-gradient(135deg, var(--accent), #ff4d4d);
            color: white;
            border: none;
            padding: 16px;
            font-size: 1rem;
            border-radius: 12px;
            cursor: pointer;
            width: 100%;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(233, 69, 96, 0.3);
            margin-bottom: 15px;
        }

        .btn:disabled { background: #444; box-shadow: none; cursor: not-allowed; }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .stat-card {
            background: rgba(0,0,0,0.2);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-val { display: block; font-size: 1.2rem; font-weight: bold; color: var(--success); }
        .stat-name { font-size: 0.65rem; color: #777; text-transform: uppercase; }

        .progress-bar {
            width: 0%;
            height: 4px;
            background-color: var(--success);
            position: absolute;
            bottom: 0;
            left: 0;
            transition: width 0.1s linear;
        }

        #status { font-size: 0.9rem; margin-bottom: 10px; font-weight: 500; height: 1.2em; }

        .pulse-icon {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: var(--heart);
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 1s infinite;
            display: none;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.5; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Ballistocardiograph</h1>
        <p class="subtitle">Hold the device naturally in one hand. We are magnifying the microscopic recoil caused by your blood flow (Ballistocardiogram).</p>

        <div id="status">Ready to calibrate</div>

        <div class="graph-label">
            <span>Tremor Spectrum (8-12Hz)</span>
            <span id="hz-label">-- Hz</span>
        </div>
        <div class="meter-container">
            <svg width="100%" height="100%" preserveAspectRatio="none">
                <path id="tremor-line" d="" />
            </svg>
        </div>

        <div class="graph-label">
            <span>Heart Recoil Magnifier (BCG)</span>
            <span id="bpm-label" style="color:var(--heart)">-- BPM</span>
        </div>
        <div class="meter-container">
            <svg width="100%" height="100%" preserveAspectRatio="none">
                <line x1="0" y1="50%" x2="100%" y2="50%" stroke="#222" stroke-width="1" />
                <path id="heart-line" d="" />
            </svg>
            <div id="progress" class="progress-bar"></div>
        </div>

        <button id="start-btn" class="btn" onclick="startCapture()">Start Bio-Scan</button>

        <div class="stats-grid">
            <div class="stat-card">
                <span id="res-stability" class="stat-val">--</span>
                <span class="stat-name">Stability Index</span>
            </div>
            <div class="stat-card">
                <span id="res-verdict" class="stat-val" style="font-size: 0.9rem;">--</span>
                <span class="stat-name">Biometric Match</span>
            </div>
        </div>
    </div>

<script>
    let rawData = [];
    let isRecording = false;
    let startTime = null;
    const DURATION = 12000; 

    // Visual elements
    const btn = document.getElementById('start-btn');
    const status = document.getElementById('status');
    const tremorLine = document.getElementById('tremor-line');
    const heartLine = document.getElementById('heart-line');
    const progressBar = document.getElementById('progress');
    const bpmLabel = document.getElementById('bpm-label');
    const hzLabel = document.getElementById('hz-label');

    // Signal processing vars
    let lastZ = 0;
    let smoothedZ = 0;

    async function startCapture() {
        if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
            const state = await DeviceMotionEvent.requestPermission();
            if (state !== 'granted') return alert("Permission required");
        }

        rawData = [];
        isRecording = true;
        startTime = Date.now();
        btn.disabled = true;
        status.innerHTML = '<span class="pulse-icon" style="display:inline-block"></span> Capturing Bio-Data...';
        
        window.addEventListener('devicemotion', handleMotion);
        requestAnimationFrame(updateLoop);
    }

    function handleMotion(event) {
        if (!isRecording) return;
        const acc = event.accelerationIncludingGravity || event.acceleration;
        if (!acc || acc.z === null) return;

        rawData.push({
            t: Date.now(),
            x: acc.x,
            y: acc.y,
            z: acc.z
        });
    }

    function updateLoop() {
        if (!isRecording) return;

        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / DURATION, 1);
        progressBar.style.width = (progress * 100) + "%";

        renderGraphs();

        if (elapsed < DURATION) {
            requestAnimationFrame(updateLoop);
        } else {
            stopCapture();
        }
    }

    function renderGraphs() {
        if (rawData.length < 10) return;

        // 1. Tremor Graph (Raw high-frequency jitter)
        const tremorSlice = rawData.slice(-60);
        const tPoints = tremorSlice.map((pt, i) => {
            const x = (i / (tremorSlice.length - 1)) * 100;
            // High pass: Subtract mean roughly
            const y = 50 - (pt.x * 15); 
            return `${x},${y}`;
        }).join(" ");
        tremorLine.setAttribute("d", `M ${tPoints}`);

        // 2. Heartbeat Graph (Ballistocardiogram magnification)
        // We use Z-axis (up/down) as heart recoil is often most visible there
        // or Y-axis if holding upright. Let's use a combination magnitude.
        const heartSlice = rawData.slice(-120);
        
        // Simple Low-Pass filter to find the "pulse" among the "shake"
        let displayPoints = [];
        let runningAvg = 0;
        
        // Calculate dynamic DC offset (gravity) to keep it centered
        const meanZ = heartSlice.reduce((a, b) => a + b.z, 0) / heartSlice.length;

        heartSlice.forEach((pt, i) => {
            const x = (i / (heartSlice.length - 1)) * 100;
            
            // The signal: Difference from gravity
            const signal = pt.z - meanZ;
            
            // Magnify by 300x to see sub-perceptible movement
            // Then apply smoothing to the display
            runningAvg = (runningAvg * 0.8) + (signal * 0.2);
            const y = 50 - (runningAvg * 400); 
            displayPoints.push(`${x},${y}`);
        });

        heartLine.setAttribute("d", `M ${displayPoints.join(" ")}`);
    }

    function stopCapture() {
        isRecording = false;
        window.removeEventListener('devicemotion', handleMotion);
        btn.disabled = false;
        btn.textContent = "Re-Scan Biometrics";
        status.textContent = "Scan Complete";
        
        processBiometrics();
    }

    function processBiometrics() {
        // Calculate Tremor Freq
        const zVals = rawData.map(d => d.z);
        const meanZ = zVals.reduce((a, b) => a + b) / zVals.length;
        let crossings = 0;
        for(let i=1; i<zVals.length; i++) {
            if((zVals[i] > meanZ && zVals[i-1] <= meanZ) || (zVals[i] < meanZ && zVals[i-1] >= meanZ)) crossings++;
        }
        const tremorFreq = (crossings/2) / (DURATION/1000);
        hzLabel.textContent = tremorFreq.toFixed(1) + " Hz";

        // Estimate Heart Rate (Simple peak detection in filtered data)
        // In a real app, we'd use an FFT (Fast Fourier Transform)
        let smoothedData = [];
        for(let i=2; i<zVals.length-2; i++) {
            smoothedData.push((zVals[i-2]+zVals[i-1]+zVals[i]+zVals[i+1]+zVals[i+2])/5 - meanZ);
        }
        
        let peaks = 0;
        for(let i=1; i<smoothedData.length-1; i++) {
            if(smoothedData[i] > 0.01 && smoothedData[i] > smoothedData[i-1] && smoothedData[i] > smoothedData[i+1]) {
                peaks++;
            }
        }
        // Normalize peaks over time to BPM (Rough estimation)
        const bpm = Math.round((peaks / (DURATION/1000)) * 60 / 1.5); // 1.5 is a correction factor for noise-peaks
        bpmLabel.textContent = (bpm > 40 && bpm < 180) ? bpm + " BPM" : "Refining...";

        // Stability
        const variance = zVals.reduce((a, b) => a + Math.pow(b - meanZ, 2), 0) / zVals.length;
        const stability = Math.sqrt(variance);
        document.getElementById('res-stability').textContent = stability.toFixed(3);

        const verdict = document.getElementById('res-verdict');
        if (stability < 0.005) {
            verdict.textContent = "ROBOT";
            verdict.style.color = "var(--accent)";
        } else if (stability > 0.5) {
            verdict.textContent = "EXCESSIVE";
            verdict.style.color = "orange";
        } else {
            verdict.textContent = "HUMAN";
            verdict.style.color = "var(--success)";
        }
    }
</script>

</body>
</html>

