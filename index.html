<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Data Transfer with WebRTC and PeerJS</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
</head>
<body>
    <h1>P2P Data Transfer</h1>

    <!-- Display for Desktop -->
    <div id="desktop">
        <h2>Desktop (Server)</h2>
        <p>Peer ID: <span id="peerId">Generating...</span></p>
        
        <h3>Update Data</h3>
        <form id="dataForm">
            <label for="name">Name:</label>
            <input type="text" id="nameInput" name="name"><br><br>

            <label for="zipcode">Zipcode:</label>
            <input type="text" id="zipcodeInput" name="zipcode"><br><br>

            <label for="colorId">Color ID:</label>
            <input type="text" id="colorIdInput" name="colorId"><br><br>

            <button type="button" onclick="updateData()">Update Data</button>
        </form>
    </div>

    <!-- Display for Mobile -->
    <div id="mobile" style="display:none;">
        <h2>Mobile (Client)</h2>
        <p>Name: <span id="name"></span></p>
        <p>Zipcode: <span id="zipcode"></span></p>
        <p>Color ID: <span id="colorId"></span></p>
    </div>

    <script>
        const isDesktop = !window.location.hash;

        if (isDesktop) {
            // Desktop (Server) Code
            const peer = new Peer();
            let conn;

            peer.on('open', (id) => {
                document.getElementById('peerId').textContent = id;
                window.history.pushState({}, '', `#${id}`);
                console.log(`Desktop peer ID: ${id}`);

                // Load data from localStorage and populate the form
                const storedData = JSON.parse(localStorage.getItem('userData'));
                if (storedData) {
                    document.getElementById('nameInput').value = storedData.name;
                    document.getElementById('zipcodeInput').value = storedData.zipcode;
                    document.getElementById('colorIdInput').value = storedData.colorId;
                } else {
                    // Initialize localStorage with default data if empty
                    const defaultData = {
                        name: 'John Doe',
                        zipcode: '12345',
                        colorId: 'Blue'
                    };
                    localStorage.setItem('userData', JSON.stringify(defaultData));
                    document.getElementById('nameInput').value = defaultData.name;
                    document.getElementById('zipcodeInput').value = defaultData.zipcode;
                    document.getElementById('colorIdInput').value = defaultData.colorId;
                }
            });

            peer.on('connection', (connection) => {
                conn = connection;

                conn.on('data', (receivedToken) => {
                    const secretToken = 'your-secret-token'; // Replace with a real token generation logic
                    if (receivedToken === secretToken) {
                        conn.send({ status: 'authorized' });
                        setInterval(sendData, 1000); // Send data every second
                    } else {
                        conn.send({ status: 'unauthorized' });
                        conn.close();
                    }
                });

                conn.on('close', () => {
                    console.log('Connection closed');
                });
            });

            peer.on('error', (err) => {
                console.error('PeerJS Error:', err);
                alert('An error occurred with the P2P connection: ' + err.message);
            });

            function sendData() {
                const storedData = JSON.parse(localStorage.getItem('userData'));
                if (conn && conn.open && storedData) {
                    conn.send(storedData);
                } else {
                    console.warn('Connection not open or no data in localStorage');
                }
            }

            // Function to update localStorage with new data from the form
            function updateData() {
                const newData = {
                    name: document.getElementById('nameInput').value,
                    zipcode: document.getElementById('zipcodeInput').value,
                    colorId: document.getElementById('colorIdInput').value
                };
                localStorage.setItem('userData', JSON.stringify(newData));
                alert('Data updated successfully!');
            }

        } else {
            // Mobile (Client) Code
            const remotePeerId = window.location.hash.slice(1);
            const peer = new Peer();
            let conn;

            peer.on('open', (id) => {
                console.log(`Mobile peer ID: ${id}`);
                connectToPeer(remotePeerId);
            });

            function connectToPeer(peerId) {
                conn = peer.connect(peerId);

                conn.on('open', () => {
                    console.log('Connected to server');
                    conn.send('your-secret-token'); // Replace with a real token
                });

                conn.on('data', (data) => {
                    if (data.status === 'authorized') {
                        console.log('Authorized, starting to receive data');
                        document.getElementById('mobile').style.display = 'block';
                    } else if (data.status === 'unauthorized') {
                        alert('Unauthorized access');
                        conn.close();
                    } else {
                        displayData(data);
                    }
                });

                conn.on('close', () => {
                    console.log('Connection closed, attempting to reconnect...');
                    setTimeout(() => connectToPeer(peerId), 3000); // Reconnect after 3 seconds
                });
            }

            peer.on('error', (err) => {
                console.error('PeerJS Error:', err);
                alert('An error occurred with the P2P connection: ' + err.message);
            });

            function displayData(data) {
                document.getElementById('name').textContent = data.name;
                document.getElementById('zipcode').textContent = data.zipcode;
                document.getElementById('colorId').textContent = data.colorId;
            }
        }
    </script>
</body>
</html>

