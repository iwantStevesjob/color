<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fixed P2P Sync Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <style>
        :root { --bg: #121212; --panel: #1e1e1e; --text: #e0e0e0; --accent: #00bcd4; --me: #008394; --peer: #424242; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; height: 100vh; margin: 0; }
        #app { width: 100%; max-width: 600px; background: var(--panel); display: flex; flex-direction: column; border-left: 1px solid #333; border-right: 1px solid #333; }
        header { padding: 15px; background: #252525; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        #status { font-size: 0.8rem; color: #888; transition: color 0.3s; }
        #status.on { color: var(--accent); font-weight: bold; }
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        .msg { max-width: 80%; padding: 8px 12px; border-radius: 12px; font-size: 0.9rem; word-break: break-word; }
        .msg.me { align-self: flex-end; background: var(--me); border-bottom-right-radius: 2px; }
        .msg.peer { align-self: flex-start; background: var(--peer); border-bottom-left-radius: 2px; }
        .meta { font-size: 0.65rem; opacity: 0.6; display: block; margin-bottom: 2px; }
        form { display: flex; padding: 10px; background: #252525; gap: 10px; }
        input { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #444; background: #333; color: white; outline: none; }
        button { padding: 0 20px; border-radius: 20px; border: none; background: var(--accent); color: white; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div id="app">
    <header>
        <div><strong>P2P Chat + History</strong></div>
        <div id="status">Waiting for peers...</div>
    </header>
    <div id="chat-box"></div>
    <form id="send-form">
        <input type="text" id="msg-input" placeholder="Type a message..." autocomplete="off">
        <button type="submit">Send</button>
    </form>
</div>

<script type="module">
    import { joinRoom, selfId } from 'https://esm.run/trystero/torrent';

    const ROOM_ID = 'gun-trystero-sync-fixed-v2';
    
    // 1. Setup GunDB (Local Mode Only)
    const gun = Gun({ peers: [], localStorage: true });
    const chatDB = gun.get(ROOM_ID);

    // 2. Setup Trystero
    const config = { appId: 'trystero-gun-sync-v2' };
    const room = joinRoom(config, ROOM_ID);
    
    const [sendLive, getLive] = room.makeAction('liveMsg');
    const [reqHistory, getReqHistory] = room.makeAction('reqHistory');
    const [resHistory, getResHistory] = room.makeAction('resHistory');

    // UI Refs
    const ui = {
        box: document.getElementById('chat-box'),
        form: document.getElementById('send-form'),
        input: document.getElementById('msg-input'),
        status: document.getElementById('status')
    };

    // --- LOGIC 1: SENDING MESSAGES ---
    ui.form.addEventListener('submit', (e) => {
        e.preventDefault();
        const text = ui.input.value.trim();
        if (!text) return;

        const msg = {
            id: Date.now() + '-' + Math.random().toString(36).substr(2, 5),
            text: text,
            sender: selfId,
            ts: Date.now()
        };

        // Save locally immediately
        chatDB.get(msg.id).put(msg);
        
        // Broadcast to peers
        sendLive(msg);
        
        ui.input.value = '';
    });

    // --- LOGIC 2: RECEIVING LIVE MESSAGES ---
    getLive((msg) => {
        // When we get a message, save it to Gun. 
        // Gun's listener (Logic 3) will handle the display.
        chatDB.get(msg.id).put(msg);
    });

    // --- LOGIC 3: RENDERING (Single Source of Truth) ---
    // We ONLY render from GunDB. 
    const seenIds = new Set();
    
    // Gun .map() iterates over every item in the DB
    chatDB.map().on((msg, id) => {
        if (!msg || !msg.text || seenIds.has(id)) return;
        seenIds.add(id);
        
        // Render
        const isMe = msg.sender === selfId;
        const div = document.createElement('div');
        div.className = `msg ${isMe ? 'me' : 'peer'}`;
        div.innerHTML = `<span class="meta">${isMe ? 'You' : msg.sender.slice(0,4)}</span>${msg.text}`;
        
        // Simple sort by timestamp (append to bottom)
        // In a real app, you might want to insertSort based on msg.ts
        ui.box.appendChild(div);
        ui.box.scrollTop = ui.box.scrollHeight;
    });

    // --- LOGIC 4: SYNCING HISTORY (The Fix) ---

    // A. When I find a NEW peer...
    room.onPeerJoin((peerId) => {
        updateStatus();
        console.log(`Connected to ${peerId}. Asking for history...`);
        
        // KEY FIX: Ask specific peer for history immediately upon connection
        reqHistory('please_sync', peerId);
    });

    room.onPeerLeave(() => updateStatus());

    // B. Someone asked ME for history
    getReqHistory((data, requestorId) => {
        console.log(`Peer ${requestorId} asked for history. Gathering...`);
        
        // Gather all messages from my local GunDB
        const historyBatch = [];
        chatDB.map().once((msg) => {
            if (msg && msg.text) {
                historyBatch.push(msg);
            }
        });

        // Wait a tiny bit for .map() to finish, then send
        setTimeout(() => {
            if (historyBatch.length > 0) {
                console.log(`Sending ${historyBatch.length} messages to ${requestorId}`);
                // Send the whole batch (Trystero handles JSON serialization)
                resHistory(historyBatch, requestorId);
            }
        }, 500);
    });

    // C. I received a history batch
    getResHistory((batch) => {
        console.log(`Received ${batch.length} messages from peer.`);
        batch.forEach(msg => {
            // Save to GunDB. Logic 3 will pick these up and render them!
            chatDB.get(msg.id).put(msg);
        });
    });

    function updateStatus() {
        const count = Object.keys(room.getPeers()).length;
        ui.status.innerText = count > 0 ? `ðŸŸ¢ ${count} Peer(s) Online` : 'ðŸŸ¡ Waiting for peers...';
        if (count > 0) ui.status.classList.add('on');
        else ui.status.classList.remove('on');
    }

</script>
</body>
</html>
