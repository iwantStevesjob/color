<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Shared Editor (Stable)</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <style>
        :root {
            --bg: #ffffff;
            --text: #1a1a1a;
            --line-height: 24px;
        }
        
        body { 
            margin: 0; font-family: 'Courier New', Courier, monospace;
            background: var(--bg); color: var(--text); 
            overflow: hidden; height: 100vh; display: flex; flex-direction: column; 
        }

        /* --- LOGIN --- */
        #login {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #login.hidden { display: none; }
        #login input { padding: 15px; font-size: 1.2rem; border: 2px solid #333; margin-bottom: 15px; text-align: center; border-radius: 8px; }
        #login button { padding: 15px 30px; background: #333; color: white; border: none; cursor: pointer; font-size: 1rem; border-radius: 8px; font-weight: bold; }

        /* --- UI --- */
        #header {
            height: 50px; background: #f8f9fa; border-bottom: 1px solid #ddd;
            display: flex; justify-content: space-between; align-items: center; padding: 0 20px;
            font-family: -apple-system, system-ui, sans-serif;
        }
        .status { font-size: 0.8rem; color: #666; display: flex; align-items: center; gap: 8px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; background: #ccc; transition: background 0.3s; }
        .dot.on { background: #00e676; box-shadow: 0 0 5px #00e676; }

        #container { 
            flex: 1; overflow-y: auto; overflow-x: hidden; scroll-behavior: smooth; 
            padding-bottom: 50vh; 
        }

        #display {
            min-height: 100%; outline: none; 
            padding: 40px 60px;
            font-size: 16px; line-height: var(--line-height);
        }

        /* --- LINE LOCKING --- */
        .editor-line {
            min-height: var(--line-height);
            padding-left: 5px;
            border-left: 4px solid transparent; 
            margin-bottom: 1px;
            position: relative;
        }

        /* Remote User Lock Styling */
        .locked-line {
            background-color: rgba(0, 0, 0, 0.03);
            transition: background 0.2s, border-color 0.2s;
        }
        .locked-tag {
            position: absolute;
            left: -60px; /* Float in the margin */
            top: 0;
            font-size: 0.7rem;
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: sans-serif;
            text-align: right;
            width: 50px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            pointer-events: none;
        }

        /* My Active Line */
        .my-line { background-color: rgba(0, 0, 0, 0.01); }

        /* --- TOOLS --- */
        #tools {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #222; padding: 10px; border-radius: 50px; 
            display: flex; gap: 10px; opacity: 0; pointer-events: none; transition: 0.2s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        #tools.visible { opacity: 1; pointer-events: auto; }
        #tools button { width: 36px; height: 36px; border-radius: 50%; border:none; cursor: pointer; background: #444; color: white; font-weight: bold; }
        #tools button:hover { background: #666; }

    </style>
</head>
<body>

    <!-- 1. LOGIN -->
    <div id="login">
        <h2>P2P Collaborative Editor</h2>
        <input type="text" id="color-input" placeholder="Enter Room Name (e.g. blue)" required>
        <button id="btn-login">Join Room</button>
    </div>

    <!-- 2. APP UI -->
    <div id="header">
        <strong>Shared Document</strong>
        <div class="status">
            <span class="dot"></span>
            <span id="peer-count">Connecting...</span>
        </div>
    </div>

    <div id="container">
        <div id="display" contenteditable="true" spellcheck="false"></div>
    </div>

    <!-- 3. TOOLS -->
    <div id="tools">
        <button id="btn-bold">B</button>
        <button id="btn-italic">I</button>
        <button id="btn-link">ðŸ”—</button>
    </div>

    <script type="module">
        import { joinRoom, selfId } from 'https://esm.run/trystero/torrent';

        // --- STATE ---
        const ui = {
            login: document.getElementById('login'),
            input: document.getElementById('color-input'),
            display: document.getElementById('display'),
            container: document.getElementById('container'),
            peerCount: document.getElementById('peer-count'),
            dot: document.querySelector('.dot'),
            tools: document.getElementById('tools')
        };

        const myColor = generateColor(selfId);
        let roomId = null;
        let roomDB, room;
        
        // Actions container
        const act = {}; 
        
        // Locking State: { "peerId": { lineId: "...", ts: 123456 } }
        const activeLocks = {}; 

        // --- 1. BOOTSTRAP ---
        
        function checkHash() {
            const hash = window.location.hash.replace('#', '');
            if(hash) {
                roomId = 'doc-stable-' + hash;
                ui.login.classList.add('hidden');
                startApp();
            } else {
                ui.login.classList.remove('hidden');
            }
        }

        document.getElementById('btn-login').onclick = () => {
            const val = ui.input.value.trim();
            if(val) {
                window.location.hash = val;
                checkHash();
            }
        };

        window.addEventListener('load', checkHash);

        // --- 2. INIT NETWORK ---

        function startApp() {
            // A. GunDB
            const gun = Gun({ peers: [], localStorage: true });
            roomDB = gun.get(roomId);

            // B. Trystero with STABLE TRACKERS
            const config = { 
                appId: 'doc-block-stable-v1',
                trackerUrls: [
                    'wss://tracker.webtorrent.dev', 
                    'wss://tracker.openwebrtc.io',
                    'wss://tracker.files.fm:7073/announce',
                    'wss://tracker.au.webtorrent.dev/announce'
                ]
            };
            room = joinRoom(config, roomId);

            // C. Actions
            const [sendContent, getContent] = room.makeAction('content');
            const [sendLock, getLock] = room.makeAction('lock');
            const [pushSync, getPushSync] = room.makeAction('sync');

            act.sendContent = sendContent;
            act.sendLock = sendLock;
            act.pushSync = pushSync;

            // D. Listeners
            getContent(handleRemoteContent);
            getLock(handleRemoteLock);
            getPushSync(handleSync);
            
            room.onPeerJoin(handlePeerJoin);
            room.onPeerLeave(handlePeerLeave);

            // E. Load Local Data
            roomDB.get('content').once((data) => {
                if(data && data.includes('class="editor-line"')) {
                    ui.display.innerHTML = data;
                } else {
                    // Start fresh
                    ui.display.innerHTML = createLine() + createLine() + createLine();
                }
                ensureStructure();
            });
        }

        // --- 3. CORE EDITOR LOGIC ---

        function createLine() {
            const id = 'line-' + Math.random().toString(36).substr(2, 9);
            return `<div id="${id}" class="editor-line"><br></div>`;
        }

        function ensureStructure() {
            const children = Array.from(ui.display.children);
            if(children.length === 0) {
                ui.display.innerHTML = createLine();
                return;
            }
            children.forEach(child => {
                if(child.tagName !== 'DIV' || !child.id) {
                    child.outerHTML = `<div id="line-${Math.random().toString(36).substr(2,9)}" class="editor-line">${child.innerHTML || '<br>'}</div>`;
                }
                if(!child.classList.contains('editor-line')) child.classList.add('editor-line');
            });
        }

        // --- 4. INPUT & SYNC ---

        ui.display.addEventListener('input', () => {
            ensureStructure(); 
            const html = ui.display.innerHTML;
            
            roomDB.get('content').put(html);
            if(act.sendContent) act.sendContent(html);
        });

        function handleRemoteContent(html) {
            roomDB.get('content').put(html);
            if(!document.hasFocus()) {
                ui.display.innerHTML = html;
            } else {
                const saved = saveSelection();
                ui.display.innerHTML = html;
                restoreSelection(saved);
            }
            reapplyVisualLocks();
        }

        function handleSync(html) {
            // New peer sends us their state
            ui.display.innerHTML = html;
            roomDB.get('content').put(html);
        }

        // --- 5. LINE LOCKING LOGIC ---

        // A. Broadcast my location
        document.addEventListener('selectionchange', () => {
            const sel = window.getSelection();
            if(!sel.rangeCount) return;

            let node = sel.anchorNode;
            if(node.nodeType === 3) node = node.parentNode;
            const line = node.closest('.editor-line');

            if(line && line.id) {
                document.querySelectorAll('.my-line').forEach(e => e.classList.remove('my-line'));
                line.classList.add('my-line');
                ui.tools.classList.toggle('visible', sel.toString().length > 0);
                if(act.sendLock) act.sendLock({ lineId: line.id, peerId: selfId });
            }
        });

        // B. Handle Incoming Locks
        function handleRemoteLock(data, peerId) {
            activeLocks[peerId] = { 
                lineId: data.lineId, 
                ts: Date.now(), 
                color: stringToColor(peerId) 
            };
            reapplyVisualLocks();
        }

        function reapplyVisualLocks() {
            document.querySelectorAll('.locked-line').forEach(el => {
                el.classList.remove('locked-line');
                el.style.borderLeftColor = 'transparent';
                const tag = el.querySelector('.locked-tag');
                if(tag) tag.remove();
            });

            const now = Date.now();
            for(const [pid, lock] of Object.entries(activeLocks)) {
                if(now - lock.ts > 30000) continue; 
                if(pid === selfId) continue;

                const el = document.getElementById(lock.lineId);
                if(el) {
                    el.classList.add('locked-line');
                    el.style.borderLeftColor = lock.color;

                    const tag = document.createElement('div');
                    tag.className = 'locked-tag';
                    tag.innerText = pid.slice(0,4);
                    tag.style.backgroundColor = lock.color;
                    
                    el.appendChild(tag);
                }
            }
        }

        // C. ENFORCE LOCKS
        ui.display.addEventListener('keydown', (e) => {
            const sel = window.getSelection();
            if(!sel.rangeCount) return;
            let node = sel.anchorNode;
            if(node.nodeType === 3) node = node.parentNode;
            const line = node.closest('.editor-line');

            if(line && line.classList.contains('locked-line')) {
                e.preventDefault();
                return; // Silently block or alert
            }

            if(e.key === 'Enter') {
                e.preventDefault();
                document.execCommand('insertHTML', false, createLine());
            }
        });

        // --- 6. PEER MANAGEMENT ---

        function handlePeerJoin(id) {
            updateStatus();
            if(ui.display.innerHTML.length > 50 && act.pushSync) {
                act.pushSync(ui.display.innerHTML, id);
            }
        }

        function handlePeerLeave(id) {
            updateStatus();
            delete activeLocks[id];
            reapplyVisualLocks();
        }

        function updateStatus() {
            const count = Object.keys(room.getPeers()).length;
            ui.peerCount.innerText = count > 0 ? `${count} Peer(s)` : 'Waiting for peers...';
            ui.dot.classList.toggle('on', count > 0);
        }

        // --- 7. INFINITE SCROLL ---
        ui.container.addEventListener('scroll', () => {
            if(ui.container.scrollHeight - ui.container.scrollTop - ui.container.clientHeight < 100) {
                ui.display.insertAdjacentHTML('beforeend', createLine() + createLine());
            }
        });

        // --- HELPERS ---
        function stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
            return '#' + '00000'.substring(0, 6 - c.length) + c;
        }
        function generateColor(str) { return stringToColor(str); }

        function saveSelection() {
            const sel = window.getSelection();
            if(!sel.rangeCount) return null;
            const range = sel.getRangeAt(0);
            const startNode = range.startContainer.nodeType === 3 ? range.startContainer.parentNode : range.startContainer;
            const line = startNode.closest('.editor-line');
            if(!line) return null;
            return { lineId: line.id, offset: range.startOffset };
        }

        function restoreSelection(saved) {
            if(!saved) return;
            const line = document.getElementById(saved.lineId);
            if(line) {
                const range = document.createRange();
                range.selectNodeContents(line);
                range.collapse(false);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
            }
        }
        
        document.getElementById('btn-bold').onclick = () => document.execCommand('bold');
        document.getElementById('btn-italic').onclick = () => document.execCommand('italic');
        document.getElementById('btn-link').onclick = () => {
            const url = prompt("URL:");
            if(url) document.execCommand('createLink', false, url);
        };

    </script>
</body>
</html>
