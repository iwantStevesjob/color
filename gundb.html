<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Chat + History + Notifications</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <style>
        :root { --bg: #121212; --panel: #1e1e1e; --text: #e0e0e0; --accent: #00bcd4; --me: #008394; --peer: #424242; --sys: #666; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; height: 100vh; margin: 0; }
        #app { width: 100%; max-width: 600px; background: var(--panel); display: flex; flex-direction: column; border-left: 1px solid #333; border-right: 1px solid #333; }
        header { padding: 15px; background: #252525; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        #status { font-size: 0.8rem; color: #888; transition: color 0.3s; }
        #status.on { color: var(--accent); font-weight: bold; }
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        
        /* Message Styles */
        .msg { max-width: 80%; padding: 8px 12px; border-radius: 12px; font-size: 0.95rem; word-break: break-word; line-height: 1.4; }
        .msg.me { align-self: flex-end; background: var(--me); border-bottom-right-radius: 2px; }
        .msg.peer { align-self: flex-start; background: var(--peer); border-bottom-left-radius: 2px; }
        
        /* System Notification Style (Joined/Left) */
        .system-msg { align-self: center; font-size: 0.75rem; color: var(--sys); margin: 5px 0; font-style: italic; opacity: 0.8; }
        
        .meta { font-size: 0.65rem; opacity: 0.6; display: block; margin-bottom: 2px; }
        form { display: flex; padding: 10px; background: #252525; gap: 10px; border-top: 1px solid #333; }
        input { flex: 1; padding: 12px; border-radius: 25px; border: 1px solid #444; background: #333; color: white; outline: none; }
        input:focus { border-color: var(--accent); }
        button { padding: 0 20px; border-radius: 25px; border: none; background: var(--accent); color: white; font-weight: bold; cursor: pointer; transition: opacity 0.2s; }
        button:hover { opacity: 0.9; }
    </style>
</head>
<body>

<div id="app">
    <header>
        <div><strong>P2P Chat</strong></div>
        <div id="status">Waiting for peers...</div>
    </header>
    <div id="chat-box"></div>
    <form id="send-form">
        <input type="text" id="msg-input" placeholder="Type a message..." autocomplete="off">
        <button type="submit">Send</button>
    </form>
</div>

<script type="module">
    import { joinRoom, selfId } from 'https://esm.run/trystero/torrent';

    const ROOM_ID = 'gun-trystero-final-v3';
    
    // 1. Setup GunDB (Local Mode Only)
    const gun = Gun({ peers: [], localStorage: true });
    const chatDB = gun.get(ROOM_ID);

    // 2. Setup Trystero
    const config = { appId: 'trystero-gun-final-v3' };
    const room = joinRoom(config, ROOM_ID);
    
    const [sendLive, getLive] = room.makeAction('liveMsg');
    const [reqHistory, getReqHistory] = room.makeAction('reqHistory');
    const [resHistory, getResHistory] = room.makeAction('resHistory');

    // UI Refs
    const ui = {
        box: document.getElementById('chat-box'),
        form: document.getElementById('send-form'),
        input: document.getElementById('msg-input'),
        status: document.getElementById('status')
    };

    // --- LOGIC 1: SENDING ---
    ui.form.addEventListener('submit', (e) => {
        e.preventDefault();
        const text = ui.input.value.trim();
        if (!text) return;

        const msg = {
            id: Date.now() + '-' + Math.random().toString(36).substr(2, 5),
            text: text,
            sender: selfId,
            ts: Date.now()
        };

        chatDB.get(msg.id).put(msg); // Save Local
        sendLive(msg);               // Send Network
        ui.input.value = '';
    });

    // --- LOGIC 2: RECEIVING LIVE ---
    getLive((msg) => {
        chatDB.get(msg.id).put(msg);
    });

    // --- LOGIC 3: RENDERING (Single Source of Truth) ---
    const seenIds = new Set();
    
    chatDB.map().on((msg, id) => {
        if (!msg || !msg.text || seenIds.has(id)) return;
        seenIds.add(id);
        
        const isMe = msg.sender === selfId;
        const div = document.createElement('div');
        div.className = `msg ${isMe ? 'me' : 'peer'}`;
        div.innerHTML = `<span class="meta">${isMe ? 'You' : msg.sender.slice(0,4)}</span>${msg.text}`;
        
        ui.box.appendChild(div);
        ui.box.scrollTop = ui.box.scrollHeight;
    });

    // --- LOGIC 4: SYNC & NOTIFICATIONS ---

    room.onPeerJoin((peerId) => {
        updateStatus();
        // 1. Show Notification
        addSystemMessage(`${peerId.slice(0,4)} joined the chat`);
        
        // 2. Sync History
        console.log(`Connected to ${peerId}. Asking for history...`);
        reqHistory('please_sync', peerId);
    });

    room.onPeerLeave((peerId) => {
        updateStatus();
        // Show Notification
        addSystemMessage(`${peerId.slice(0,4)} left the chat`);
    });

    // Handle History Requests
    getReqHistory((data, requestorId) => {
        const historyBatch = [];
        chatDB.map().once((msg) => {
            if (msg && msg.text) historyBatch.push(msg);
        });
        setTimeout(() => {
            if (historyBatch.length > 0) resHistory(historyBatch, requestorId);
        }, 500);
    });

    // Handle History Response
    getResHistory((batch) => {
        batch.forEach(msg => chatDB.get(msg.id).put(msg));
    });

    // --- HELPERS ---
    function updateStatus() {
        const count = Object.keys(room.getPeers()).length;
        ui.status.innerText = count > 0 ? `ðŸŸ¢ ${count} Peer(s) Online` : 'ðŸŸ¡ Waiting for peers...';
        if (count > 0) ui.status.classList.add('on');
        else ui.status.classList.remove('on');
    }

    function addSystemMessage(text) {
        const div = document.createElement('div');
        div.className = 'system-msg';
        div.innerText = text;
        ui.box.appendChild(div);
        ui.box.scrollTop = ui.box.scrollHeight;
    }

</script>
</body>
</html>
