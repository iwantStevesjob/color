<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Block Editor</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <style>
        :root {
            --bg: #ffffff;
            --text: #1a1a1a;
            --line-height: 1.5;
        }
        
        body { 
            margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); color: var(--text); 
            overflow: hidden; height: 100vh; display: flex; flex-direction: column; 
        }

        /* LOGIN */
        #login {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #login.hidden { display: none; }
        #login input { padding: 15px; font-size: 1.2rem; border: 2px solid #333; margin-bottom: 10px; text-align: center; }
        #login button { padding: 15px 30px; background: #333; color: white; border: none; cursor: pointer; font-size: 1rem; }

        /* HEADER */
        #header {
            padding: 10px 20px; background: #f4f4f4; border-bottom: 1px solid #ddd;
            display: flex; justify-content: space-between; align-items: center; height: 40px; z-index: 10;
        }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #ccc; display: inline-block; }
        .status-dot.on { background: #00e676; box-shadow: 0 0 5px #00e676; }

        /* EDITOR CONTAINER */
        #container { 
            flex: 1; overflow-y: auto; overflow-x: hidden; scroll-behavior: smooth; 
            padding-bottom: 50vh; /* Allow scrolling past bottom */
            cursor: text;
        }

        /* THE EDITOR SURFACE */
        #display {
            min-height: 100%; outline: none; 
            padding: 40px 60px;
            font-size: 16px; line-height: var(--line-height);
        }

        /* --- THE LINE LOCKING MAGIC --- */
        
        /* A standard line */
        .editor-line {
            min-height: 24px; /* Ensure empty lines are clickable */
            padding: 2px 5px;
            border-left: 3px solid transparent; /* Reserve space for lock indicator */
            margin-bottom: 2px;
            border-radius: 2px;
        }

        /* A line locked by someone else */
        .locked-line {
            background-color: rgba(0,0,0, 0.03);
            position: relative;
        }
        
        /* The user's name tag floating on the locked line */
        .locked-tag {
            position: absolute;
            right: 100%;
            top: 0;
            font-size: 0.7rem;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            white-space: nowrap;
            margin-right: 5px;
            pointer-events: none;
            font-weight: bold;
            display: flex; align-items: center;
        }

        /* When I am editing a line, highlight it slightly for me too */
        .my-active-line {
            background-color: rgba(0, 0, 0, 0.015);
        }

        /* TOOLS */
        #tools {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #222; padding: 10px; border-radius: 50px; 
            display: flex; gap: 10px; opacity: 0; pointer-events: none; transition: 0.2s;
        }
        #tools.visible { opacity: 1; pointer-events: auto; }
        #tools button { width: 30px; height: 30px; border-radius: 50%; border:none; cursor: pointer; background: #555; color: white; }

    </style>
</head>
<body>

    <!-- Login -->
    <div id="login">
        <h2>Enter Room Name</h2>
        <input type="text" id="room-input" placeholder="e.g. blue-room">
        <button id="btn-join">Join Document</button>
    </div>

    <!-- UI -->
    <div id="header">
        <strong>P2P Block Editor</strong>
        <div>
            <span class="status-dot"></span>
            <span id="peer-count" style="font-size: 0.8rem; margin-left: 5px;">Offline</span>
        </div>
    </div>

    <div id="container">
        <div id="display" contenteditable="true" spellcheck="false"></div>
    </div>

    <div id="tools">
        <button id="btn-bold">B</button>
        <button id="btn-italic">I</button>
        <button id="btn-link">ðŸ”—</button>
    </div>

    <script type="module">
        import { joinRoom, selfId } from 'https://esm.run/trystero/torrent';

        // --- STATE & CONFIG ---
        const ui = {
            login: document.getElementById('login'),
            roomInput: document.getElementById('room-input'),
            display: document.getElementById('display'),
            container: document.getElementById('container'),
            peerCount: document.getElementById('peer-count'),
            statusDot: document.querySelector('.status-dot'),
            tools: document.getElementById('tools')
        };

        const myColor = generateColor(selfId);
        let roomId = null;
        let room, roomDB;
        let actions = {};
        
        // Track who is editing what: { peerId: "line-id" }
        const activeLocks = {}; 

        // --- 1. INITIALIZATION ---

        document.getElementById('btn-join').onclick = () => {
            const val = ui.roomInput.value.trim();
            if(val) {
                roomId = 'block-doc-' + val;
                ui.login.classList.add('hidden');
                initNetwork();
            }
        };

        function initNetwork() {
            // GunDB
            const gun = Gun({ peers: [], localStorage: true });
            roomDB = gun.get(roomId);

            // Trystero
            const config = { appId: 'block-doc-v1' };
            room = joinRoom(config, roomId);
            
            actions.sendContent = room.makeAction('content')[0];
            actions.getContent = room.makeAction('content')[1];
            
            actions.sendLock = room.makeAction('lock')[0];
            actions.getLock = room.makeAction('lock')[1];

            actions.pushSync = room.makeAction('sync')[0];
            actions.getPushSync = room.makeAction('sync')[1];

            setupEvents();
            loadLocalContent();
        }

        // --- 2. CONTENT LOADING & FORMATTING ---

        function loadLocalContent() {
            roomDB.get('content').once((data) => {
                if (data && data.includes('class="editor-line"')) {
                    ui.display.innerHTML = data;
                } else {
                    // Initialize with 10 empty lines
                    let html = '';
                    for(let i=0; i<10; i++) html += createEmptyLine();
                    ui.display.innerHTML = html;
                }
                ensureLineIDs(); // Safety check
            });
        }

        // Helper: Create a line with a UUID
        function createEmptyLine() {
            const id = 'line-' + Math.random().toString(36).substr(2, 9);
            return `<div id="${id}" class="editor-line"><br></div>`;
        }

        // Safety: Ensure every single child has an ID and class
        function ensureLineIDs() {
            const children = Array.from(ui.display.children);
            let changed = false;
            children.forEach(child => {
                if (!child.id || !child.id.startsWith('line-')) {
                    child.id = 'line-' + Math.random().toString(36).substr(2, 9);
                    changed = true;
                }
                if (!child.classList.contains('editor-line')) {
                    child.classList.add('editor-line');
                    changed = true;
                }
            });
            return changed;
        }

        // --- 3. INPUT & SYNC LOGIC ---

        // Broadcast Content
        ui.display.addEventListener('input', () => {
            // If the browser messed up tags, fix them
            if(ensureLineIDs()) {
                // If we had to fix IDs, cursor might jump, save it?
                // For simplicity in this demo, we assume browser plays nice mostly
            }

            const html = ui.display.innerHTML;
            roomDB.get('content').put(html);
            actions.sendContent(html);
        });

        // Receive Content
        actions.getContent((html) => {
            roomDB.get('content').put(html);
            
            // Only update if I am NOT typing to avoid conflict
            // In a block editor, we could update *other* blocks, but let's keep it simple
            if (!document.hasFocus()) {
                ui.display.innerHTML = html;
            } else {
                // Harder problem: Merge remote changes without destroying my focus
                // For this demo: We only update if the HTML is drastically different
                // or rely on "Line Locking" to prevent conflicts in the first place.
                
                // For now, let's update but try to keep selection
                const saved = saveSelection();
                ui.display.innerHTML = html;
                restoreSelection(saved);
            }
            applyVisualLocks(); // Re-apply locks after DOM refresh
        });

        // --- 4. LINE LOCKING LOGIC (The Core Request) ---

        // A. Detect where I am
        document.addEventListener('selectionchange', () => {
            const sel = window.getSelection();
            if (!sel.rangeCount) return;
            
            // Find the closest parent line <div>
            let node = sel.anchorNode;
            if (node.nodeType === 3) node = node.parentNode; // Text node -> Element
            
            const lineElement = node.closest('.editor-line');
            
            if (lineElement && lineElement.id) {
                // Highlight my own line
                document.querySelectorAll('.my-active-line').forEach(el => el.classList.remove('my-active-line'));
                lineElement.classList.add('my-active-line');

                // Broadcast lock
                actions.sendLock({ lineId: lineElement.id, peerId: selfId });
            }
        });

        // B. Receive Locks
        actions.getLock((data, peerId) => {
            activeLocks[peerId] = { lineId: data.lineId, ts: Date.now(), color: stringToColor(peerId) };
            applyVisualLocks();
        });

        // C. Apply Visuals & Enforce Locks
        function applyVisualLocks() {
            // Clear old locks
            document.querySelectorAll('.locked-line').forEach(el => {
                el.classList.remove('locked-line');
                el.style.borderLeftColor = 'transparent';
                const tag = el.querySelector('.locked-tag');
                if(tag) tag.remove();
            });

            // Apply new locks
            const now = Date.now();
            for (const [peerId, lock] of Object.entries(activeLocks)) {
                // Expire lock after 10 seconds of inactivity
                if (now - lock.ts > 10000) continue; 
                
                if (peerId === selfId) continue; // Don't lock myself

                const el = document.getElementById(lock.lineId);
                if (el) {
                    el.classList.add('locked-line');
                    el.style.borderLeftColor = lock.color;

                    // Add Name Tag
                    const tag = document.createElement('div');
                    tag.className = 'locked-tag';
                    tag.innerText = peerId.slice(0, 4);
                    tag.style.backgroundColor = lock.color;
                    el.appendChild(tag);
                }
            }
        }

        // D. THE ENFORCER: Prevent typing in locked lines
        ui.display.addEventListener('keydown', (e) => {
            // 1. Handle Enter (Ensure new lines get IDs)
            if (e.key === 'Enter') {
                // Let default happen, but then immediately ID it? 
                // Better: ExecCommand insertParagraph usually makes a div.
                // We rely on MutationObserver or Input event to fix ID.
            }

            // 2. Lock Check
            const sel = window.getSelection();
            if (!sel.rangeCount) return;
            let node = sel.anchorNode;
            if (node.nodeType === 3) node = node.parentNode;
            const line = node.closest('.editor-line');

            if (line && line.classList.contains('locked-line')) {
                e.preventDefault();
                alert("This line is being edited by someone else!");
            }
        });

        // --- 5. NETWORK EVENTS ---

        function setupEvents() {
            room.onPeerJoin(peerId => {
                updateStatus();
                // Push data to new peer
                actions.pushSync(ui.display.innerHTML, peerId);
            });
            room.onPeerLeave(peerId => {
                updateStatus();
                delete activeLocks[peerId];
                applyVisualLocks();
            });
            
            actions.getPushSync(html => {
                roomDB.get('content').put(html);
                ui.display.innerHTML = html;
                ensureLineIDs();
            });
        }

        function updateStatus() {
            const count = Object.keys(room.getPeers()).length;
            ui.peerCount.innerText = `${count} Peer(s)`;
            ui.statusDot.classList.toggle('on', count > 0);
        }

        // --- 6. INFINITE SCROLL ---

        ui.container.addEventListener('scroll', () => {
            const { scrollTop, scrollHeight, clientHeight } = ui.container;
            
            // Add to Bottom
            if (scrollHeight - scrollTop - clientHeight < 100) {
                let html = '';
                for(let i=0; i<5; i++) html += createEmptyLine();
                ui.display.insertAdjacentHTML('beforeend', html);
            }
        });

        // --- HELPERS ---

        function saveSelection() {
            const sel = window.getSelection();
            if(!sel.rangeCount) return null;
            
            const range = sel.getRangeAt(0);
            const startNode = range.startContainer.nodeType === 3 ? range.startContainer.parentNode : range.startContainer;
            const startLine = startNode.closest('.editor-line');
            
            if(!startLine) return null;

            return {
                lineId: startLine.id,
                offset: range.startOffset // Simplified offset
            };
        }

        function restoreSelection(saved) {
            if(!saved) return;
            const line = document.getElementById(saved.lineId);
            if(line) {
                const range = document.createRange();
                // Try to put cursor at end of that line (simple restoration)
                range.selectNodeContents(line);
                range.collapse(false); 
                
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
            }
        }

        function stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
            return '#' + '00000'.substring(0, 6 - c.length) + c;
        }

        function generateColor(str) { return stringToColor(str); }

        // Tools Handling
        document.addEventListener('selectionchange', () => {
             const txt = window.getSelection().toString();
             ui.tools.classList.toggle('visible', txt.length > 0);
        });
        
        document.getElementById('btn-bold').onclick = () => document.execCommand('bold');
        document.getElementById('btn-italic').onclick = () => document.execCommand('italic');
        document.getElementById('btn-link').onclick = () => {
            const url = prompt("URL:");
            if(url) document.execCommand('createLink', false, url);
        }

    </script>
</body>
</html>
